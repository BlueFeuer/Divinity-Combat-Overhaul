Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Ghosts(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,CHARACTERGUID_S_GLO_Meistr_Ghost_2486c7e1-261b-4f49-9f49-812593f6c41a,"RC_DW_Meistr_Ghost");
DB_DeadEvent(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_Dead");

//Gallows
CharacterSetAnimationSetOverride(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d, "Crippled");
ApplyStatus(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"GROUNDED",-1.0);
ItemSetCanInteract(ITEMGUID_S_RC_DW_MeistrGallows_09d00035-7d34-497a-a446-3afc30002a97,0);
CharacterSetHitpointsPercentage(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,5.0);
CharacterSetCanTrade(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0);
DB_Dialogs(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_Gallows");
DB_Dialogs(CHARACTERGUID_S_RC_DW_MeistrGuard_8a8a83dd-de7b-42aa-8ab9-d4fc1e878126,"RC_DW_MeistrGuard");
DB_Dialogs(CHARACTERGUID_S_RC_DW_MeistrGuard_SilentMonk_01_b4e39447-8186-4917-9cfa-766b825d3b13,"RC_DW_MeistrGuard_SilentMonk");
ItemToInventory(ITEMGUID_S_RC_DW_Meistr_SafeCombo_646d08f3-f85f-4e78-87f4-273cc5176d71,CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DW_NoticeGallows_feef4424-a58c-4f12-8ba9-c9eb3140cca7);
DB_DeadEvent(CHARACTERGUID_S_RC_DW_MeistrGuard_8a8a83dd-de7b-42aa-8ab9-d4fc1e878126,"RC_DW_MeistrGuard_Dead");
ProcCharacterDisableAllCrimes(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
DB_KeepDialogsOnDeath(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
DB_DialogMoneyTransfer(1,"RC_DW_MeistrGuard",10); //Magister Ninyan Bribe Attempt #1
DB_DialogMoneyTransfer(2,"RC_DW_MeistrGuard",20); //Magister Ninyan Bribe Attempt #2
DB_DialogMoneyTransfer(3,"RC_DW_MeistrGuard",300); //Magister Ninyan Bribe Attempt #3
DB_BlockThreatenedDialog(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
SetCanFight(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0);
CharacterSetImmortal(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,1);

//Outside House
ItemSetOwner(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d,CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
ItemSetOnlyOwnerCanUse(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d,1);
DB_Dialogs(CHARACTERGUID_S_RC_DW_Meistr_Kid_43e646a7-f18b-4738-92d5-c82bcd21d293,"RC_DW_Meistr_Kid");

//Inside house ground floor
DB_GLO_Attribute_Check_AgainstLevel("RC_DW_Meistr_Vault",1,"Wits","Hard",2,9);

ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a);
SetOnStage(ITEMGUID_S_RC_DW_Meistr_House_Button_e53dceb1-9ce1-464d-a1bd-4c3ee2ed8a10,0);
SetOnStage(ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,0);

//Cellar
DB_OneShotUser_VoicebarkTrigger(TRIGGERGUID_S_RC_DW_Meistr_VB_Cellar_1ca2fffe-de4b-4728-8065-4c2f1f54b3bc,"RC_DW_VB_Meistr_Artefact_Intro");
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c);
TriggerRegisterForCharacter(TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c,CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
DB_Ghosts(CHARACTERGUID_S_RC_DW_Meistr_ApprenticeGhost_bbdacbbe-c3f7-463a-b591-30ba694ea669,"RC_DW_Meistr_ApprenticeGhost");
DB_Dialogs(ITEMGUID_S_RC_DW_Meistr_Cellar_Ingredient_Cupboard_7986fb70-9060-4c5a-bfb1-cb70d7c9c188,"RC_DW_Meistr_IngredientCupboard");
DB_SourceFountains(ITEMGUID_S_RC_DW_Meistr_SourceFountain_b0d81910-b163-4de4-b1fb-2dc3561035f2,TRIGGERGUID_S_RC_DW_Meistr_Cellar_SourceFountainSpawn_862caac8-da11-4eb1-aad2-7d2aa29fca96);

//Dream
DB_RC_DB_Meistr_Dream((TRIGGERGUID)TRIGGERGUID_S_RC_DW_Meistr_Dream_Arrive1_c451bc1a-4269-4d3b-b26e-e690e0e12b1f,(ITEMGUID)ITEMGUID_S_RC_DW_Meistr_Dream_Portal1_1b653e20-1b67-48d9-8554-55e20f12dbc3,(CHARACTERGUID)S_RC_DW_Meistr_God1_b72eed9a-e178-4e6b-b425-13c177e9a9ae);
DB_RC_DB_Meistr_Dream(TRIGGERGUID_S_RC_DW_Meistr_Dream_Arrive2_a3f32814-386f-417e-937a-7602843020e1,ITEMGUID_S_RC_DW_Meistr_Dream_Portal2_3938eaad-4bad-46c1-987a-d1497051752d,CHARACTERGUID_S_RC_DW_Meistr_God2_8b5641e3-606c-49e9-9e29-59e688049d88);
DB_RC_DB_Meistr_Dream(TRIGGERGUID_S_RC_DW_Meistr_Dream_Arrive3_a50bd114-a1ae-4248-9ec1-92287781c6ce,ITEMGUID_S_RC_DW_Meistr_Dream_Portal3_af329720-37eb-4776-a5c8-b3158103a8ad,CHARACTERGUID_S_RC_DW_Meistr_God3_233040fc-0f84-4c4c-acbe-f9a4cad8ac29);
DB_RC_DB_Meistr_Dream(TRIGGERGUID_S_RC_DW_Meistr_Dream_Arrive4_c8ce6ef2-8f5c-4fbd-8ea4-a0b865fc15fa,ITEMGUID_S_RC_DW_Meistr_Dream_Portal4_f11a1691-8939-463c-a1f3-933463eee64e,CHARACTERGUID_S_RC_DW_Meistr_God4_027f3423-2845-4a61-a506-f0ef4df1f693);
Proc_PyramidBlockerTriggerAdd(S_RC_DW_Meistr_DreamScene_f206d532-488e-469f-bb2a-5fb4270aa438);

DB_RC_DB_Meistr_Dream_Voidwoken(CHARACTERGUID_S_RC_DW_Meistr_God1_b72eed9a-e178-4e6b-b425-13c177e9a9ae,CHARACTERGUID_RC_DW_Meistr_Voidwoken1_1_fbdd773b-5fad-45f7-bb54-81fab50853fe);
DB_RC_DB_Meistr_Dream_Voidwoken(CHARACTERGUID_S_RC_DW_Meistr_God1_b72eed9a-e178-4e6b-b425-13c177e9a9ae,CHARACTERGUID_RC_DW_Meistr_Voidwoken1_2_365b42bc-e840-4e10-a223-2bdca92a68b1);
DB_RC_DB_Meistr_Dream_Voidwoken(CHARACTERGUID_S_RC_DW_Meistr_God2_8b5641e3-606c-49e9-9e29-59e688049d88,CHARACTERGUID_RC_DW_Meistr_Voidwoken2_1_7be6e047-dcfa-42f3-9775-830c3ec52fe5);
DB_RC_DB_Meistr_Dream_Voidwoken(CHARACTERGUID_S_RC_DW_Meistr_God2_8b5641e3-606c-49e9-9e29-59e688049d88,CHARACTERGUID_RC_DW_Meistr_Voidwoken2_2_aa6725d6-8b1a-43f9-9f90-0d1f8ce3b739);
DB_RC_DB_Meistr_Dream_Voidwoken(CHARACTERGUID_S_RC_DW_Meistr_God3_233040fc-0f84-4c4c-acbe-f9a4cad8ac29,CHARACTERGUID_RC_DW_Meistr_Voidwoken3_1_1db52c33-7302-450c-bfee-388e9b4b3c73);
DB_RC_DB_Meistr_Dream_Voidwoken(CHARACTERGUID_S_RC_DW_Meistr_God3_233040fc-0f84-4c4c-acbe-f9a4cad8ac29,CHARACTERGUID_RC_DW_Meistr_Voidwoken3_2_e258e617-b0b0-4779-b257-2da7414f18ea);
DB_RC_DB_Meistr_Dream_Voidwoken(CHARACTERGUID_S_RC_DW_Meistr_God4_027f3423-2845-4a61-a506-f0ef4df1f693,CHARACTERGUID_RC_DW_Meistr_Voidwoken4_1_519fc2a3-13d5-4031-b7f4-de5f47487c6c);
DB_RC_DB_Meistr_Dream_Voidwoken(CHARACTERGUID_S_RC_DW_Meistr_God4_027f3423-2845-4a61-a506-f0ef4df1f693,CHARACTERGUID_RC_DW_Meistr_Voidwoken4_2_28c608d6-8f0b-4a18-9d75-a39d134eb835);

//Source Knowledge Unlocks
DB_RC_DW_Meistr_SourceKnowledge((CHARACTERGUID)S_RC_DW_WC_BossFight_Skeleton_Mordus_d46ade3f-f786-4fcc-975c-361a106f2853,"RC_DW_Meistr_SourceKnowledge_Mordus");
DB_RC_DW_Meistr_SourceKnowledge(CHARACTERGUID_S_GLO_Advocate_bfa3e903-78ab-46aa-9a95-54fb956eb2b3,"RC_DW_Meistr_SourceKnowledge_Advocate");
DB_RC_DW_Meistr_SourceKnowledge(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"RC_DW_Meistr_SourceKnowledge_Ryker");
DB_RC_DW_Meistr_SourceKnowledge(CHARACTERGUID_S_GLO_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,"RC_DW_Meistr_SourceKnowledge_Saheila");
DB_RC_DW_Meistr_SourceKnowledge(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"RC_DW_Meistr_SourceKnowledge_Almira");
DB_RC_DW_Meistr_SourceKnowledge(CHARACTERGUID_S_RC_BF_CorneredSourcerer_Sourcerer_b201a72c-8ead-4bbf-8612-fcd8c0944e52,"RC_DW_Meistr_SourceKnowledge_Hannag");
DB_RC_DW_Meistr_SourceKnowledge(CHARACTERGUID_S_GLO_Jahan_4d222cfd-49c8-41d3-8cb7-2a2b56232633,"RC_DW_Meistr_SourceKnowledge_Jahan");

DB_RC_DW_Meistr_SourceKnowledge_PartyFlagRefused((CHARACTERGUID)S_RC_DW_WC_BossFight_Skeleton_Mordus_d46ade3f-f786-4fcc-975c-361a106f2853,"RC_DW_WC_RefusedToEatVoidwokenHeart");
DB_RC_DW_Meistr_SourceKnowledge_PartyFlagRefused(CHARACTERGUID_S_GLO_Advocate_bfa3e903-78ab-46aa-9a95-54fb956eb2b3,"RC_BI_LizardDemon_DeclinedSP");
DB_RC_DW_Meistr_SourceKnowledge_PartyFlagRefused(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"RC_GY_Ryker_DeclinedSP");
DB_RC_DW_Meistr_SourceKnowledge_PartyFlagRefused(CHARACTERGUID_S_RC_GY_Ryker_522b8095-b539-4a82-84f3-bf8e5a74dfe4,"QuestUpdate_RC_GY_RykersContract_RefusedRykersQuest");
DB_RC_DW_Meistr_SourceKnowledge_PartyFlagRefused(CHARACTERGUID_S_GLO_Saheila_fcacdf08-b05f-4333-b0e0-ddf29c13d8e0,"RC_MIL_Saheila_DeclinedSP");
DB_RC_DW_Meistr_SourceKnowledge_PartyFlagRefused(CHARACTERGUID_S_GLO_Almira_49b466a9-e67f-4e3c-8f66-3636ba7dd54f,"QuestUpdate_RC_FL_BrokenPromises_DeclinedSP");
DB_RC_DW_Meistr_SourceKnowledge_PartyFlagRefused(CHARACTERGUID_S_RC_BF_CorneredSourcerer_Sourcerer_b201a72c-8ead-4bbf-8612-fcd8c0944e52,"RC_BF_CorneredSourcerer_RefusedPoint");
DB_RC_DW_Meistr_SourceKnowledge_PartyFlagRefused(CHARACTERGUID_S_GLO_Jahan_4d222cfd-49c8-41d3-8cb7-2a2b56232633,"RC_BF_DemonHunter_DeclinedSP");

DB_RC_DW_Meistr_VW_Attackers((CHARACTERGUID)CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_01_b31d9186-34e6-423d-9a33-f90b27f567c2);
DB_RC_DW_Meistr_VW_Attackers(CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_02_320be237-a9a6-447d-b60b-b8692e9ee470);

DB_RC_DW_Meistr_VW_Points((CHARACTERGUID)CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_01_b31d9186-34e6-423d-9a33-f90b27f567c2,1,(TRIGGERGUID)TRIGGERGUID_S_RC_DW_Meistr_KillerPoint_AtGallows_1_8677ad0b-13db-4544-927c-a10df2fc972e);
DB_RC_DW_Meistr_VW_Points(CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_01_b31d9186-34e6-423d-9a33-f90b27f567c2,2,TRIGGERGUID_S_RC_DW_Meistr_KillerPoint_AtHouse_1_1f8292a3-7e34-4c8b-ac58-b6640bf3d9ca);
DB_RC_DW_Meistr_VW_Points(CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_01_b31d9186-34e6-423d-9a33-f90b27f567c2,3,TRIGGERGUID_S_RC_DW_Meistr_KillerPoint_AtCellar_1_44239208-3a54-43d3-b246-d77f813fe77d);
DB_RC_DW_Meistr_VW_Points(CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_02_320be237-a9a6-447d-b60b-b8692e9ee470,1,TRIGGERGUID_S_RC_DW_Meistr_KillerPoint_AtGallows_2_8d105f8a-de08-460f-a5c7-2332aa4bc87e);
DB_RC_DW_Meistr_VW_Points(CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_02_320be237-a9a6-447d-b60b-b8692e9ee470,2,TRIGGERGUID_S_RC_DW_Meistr_KillerPoint_AtHouse_2_294b0f70-c123-44c5-b6a4-c2f228df0d2d);
DB_RC_DW_Meistr_VW_Points(CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_02_320be237-a9a6-447d-b60b-b8692e9ee470,3,TRIGGERGUID_S_RC_DW_Meistr_KillerPoint_AtCellar_2_45f9ac7c-9d75-440c-aacd-a2e26c86ffbe);

// Update journal to say how to get Malady to leave for CoS depending on whether she's already back on the ship or not
// (0 = Malady is not yet back on the LV, 1 = she is)
DB_RC_DW_Meistr_MaladyForCoSUpdate(0,"QuestUpdate_RC_DW_Meistr_SummonMalady");
DB_RC_DW_Meistr_MaladyForCoSUpdate(1,"QuestUpdate_RC_DW_Meistr_MaladyOnDeck");
KBSECTION
//REGION DebugEvents
IF
TextEventSet("Meistr")
THEN
ClearVarObject(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Seat");
ItemSetOnlyOwnerCanUse(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d,0);
ItemClearOwner(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
ItemUnLock(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
SetOnStage(ITEMGUID_S_RC_DW_Meistr_House_Notice_9ab791f4-14d0-453d-9522-f026fe26181c,0);
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
GlobalSetFlag("RC_DW_Meistr_Rescued");
TeleportTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,TRIGGERGUID_S_RC_DW_MeistrHouse_c6bbf267-2bb9-47ea-a92a-3fe6be512e59,"RC_DW_MeistrRunHome",1);

IF
TextEventSet("mportal")
AND
DB_IsPlayer(_Player)
AND
CharacterIsControlled(_Player,1)
AND
GetPosition(_Player,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
THEN
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

IF
TextEventSet("rc_knowmeistrcos")
AND
CharacterGetHostCharacter(_Char)
THEN
ObjectSetFlag(_Char,"RC_DW_Meistr_KnowCoS");

IF
TextEventSet("dreamcombat")
AND
DB_IsPlayer(_Player)
AND
CharacterIsControlled(_Player,1)
AND
GetPosition(_Player,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
THEN
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);
ObjectSetFlag(_Player,"GLO_Has2MaxMP");
ObjectSetFlag(_Player,"GLO_Has3MaxMP");
CharacterOverrideMaxSourcePoints(_Player,3);
CharacterAddSourcePoints(_Player,3);
ObjectSetFlag(_Player,"RC_DW_Meistr_Dream_Visit2",0);
DB_RC_DW_Meistr_DreamCombatTransformHack(1);

IF
DB_RC_DW_Meistr_GodToTransformInto(_God,_Template)
AND
DB_RC_DW_Meistr_DreamCombatTransformHack(1)
THEN
ProcObjectTimer(_God,"RC_DW_Meistr_Dream_Transform",1000);
NOT DB_RC_DW_Meistr_DreamCombatTransformHack(1);

//END_REGION

//REGION Gallows
IF
DialogEnded("RC_DW_Meistr_Gallows",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,1)
AND
DB_GlobalFlag("RC_DW_Meistr_Rescued")
AND
NOT DB_GlobalFlag("RC_DW_MeistrGuard_FreePermission")
AND
NOT DB_Dead(CHARACTERGUID_S_RC_DW_MeistrGuard_8a8a83dd-de7b-42aa-8ab9-d4fc1e878126)
THEN
DialogRequestStop(CHARACTERGUID_S_RC_DW_MeistrGuard_8a8a83dd-de7b-42aa-8ab9-d4fc1e878126);
CharacterSetTemporaryHostileRelation(CHARACTERGUID_S_RC_DW_MeistrGuard_8a8a83dd-de7b-42aa-8ab9-d4fc1e878126,(CHARACTERGUID)_Player);

IF
DialogEnded("RC_DW_Meistr_Gallows",_)
AND
DB_GlobalFlag("RC_DW_Meistr_Rescued")
THEN
ClearVarObject(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Seat");
CharacterSetAnimationOverride(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"");
PlayAnimation(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Still");
TeleportTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,TRIGGERGUID_S_RC_DW_Meistr_OffGallows_3e36450d-24c9-45a8-bb89-9f52a9bc0883);
ItemSetOnlyOwnerCanUse(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d,0);
ItemClearOwner(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
ItemUnLock(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
SetOnStage(ITEMGUID_S_RC_DW_Meistr_House_Notice_9ab791f4-14d0-453d-9522-f026fe26181c,0);
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
SetHasDialog(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0);
TimerLaunch("RC_DW_Meistr_Rescued_ShortPauseToHackAroundFrameDelays",1000);

IF
GlobalFlagSet("RC_DW_Meistr_Rescued")
THEN
ProcCharacterEnableAllCrimes(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
ProcCharacterDisableCrime(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_WH_Djinn_Item");
RemoveStatus(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"GROUNDED");


IF
TimerFinished("RC_DW_Meistr_Rescued_ShortPauseToHackAroundFrameDelays")
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,S_RC_DW_Meistr_OffGallows2_94ac79ed-7bc1-46fe-9e2d-a28970a9f2f9,0,"RC_DW_MeistrRunOffGallows");
SetCanJoinCombat(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0);

IF
StoryEvent(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_MeistrRunOffGallows")
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,TRIGGERGUID_S_RC_DW_MeistrHouse_c6bbf267-2bb9-47ea-a92a-3fe6be512e59,0,"RC_DW_MeistrRunHome");

IF
ObjectFlagSet("RC_DW_MeistrGuard_Bribe",_Player,_)
AND
DB_DialogMoneyTransfer(3,"RC_DW_MeistrGuard",_Price)
AND
IntegerSubtract(0,_Price,_RemoveGold)
THEN
ProcAddGoldToMagicPockets((CHARACTERGUID)_Player,_RemoveGold);
CharacterAddGold(CHARACTERGUID_S_RC_DW_MeistrGuard_8a8a83dd-de7b-42aa-8ab9-d4fc1e878126,_Price);

IF
GameBookInterfaceClosed(ITEMGUID_S_RC_DW_Meistr_SafeCombo_646d08f3-f85f-4e78-87f4-273cc5176d71,_Player)
AND
DB_IsPlayer(_Player)
AND
QueryOnlyOnce("RC_DW_Meistr_SafecodeReveiled")
THEN
StartVoiceBark("RC_DW_VB_Meistr_SafecodeReveiled", _Player);
ObjectSetFlag(_Player,"RC_DW_Meistr_Vault_HasSafeCombo");

IF
CharacterEnteredTrigger(_Player, TRIGGERGUID_S_RC_DW_NoticeGallows_feef4424-a58c-4f12-8ba9-c9eb3140cca7)
THEN
PartySetFlag(_Player, "RC_DW_SawGallows");

IF
DialogEnded("RC_DW_MeistrGuard",_)
AND
DB_GlobalFlag("RC_DW_MeistrGuard_FreePermission")
THEN
SetHasDialog(CHARACTERGUID_S_RC_DW_MeistrGuard_8a8a83dd-de7b-42aa-8ab9-d4fc1e878126, 0);
SetHasDialog(CHARACTERGUID_S_RC_DW_MeistrGuard_SilentMonk_01_b4e39447-8186-4917-9cfa-766b825d3b13, 0);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_RC_DW_MeistrGuard_8a8a83dd-de7b-42aa-8ab9-d4fc1e878126, 90, 0, "", 1);
ProcCharacterDisappearOutOfSight(CHARACTERGUID_S_RC_DW_MeistrGuard_SilentMonk_01_b4e39447-8186-4917-9cfa-766b825d3b13, 90, 0, "", 1);
CharacterSetReactionPriority(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"IdleAtGallows",0);

IF
CharacterDying(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Rescued")
AND
NOT DB_GlobalFlag("RC_DW_Meistr_OnBoat")
THEN
TeleportTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,S_RC_DW_Meistr_OffGallows_3e36450d-24c9-45a8-bb89-9f52a9bc0883);

//Crime reactions are disabled for meistr on the gallows, so we manually do attitude adjustments
IF
AttackedByObject(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,(CHARACTERGUID)_Player,_,_,_)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Rescued")
AND
DB_IsPlayer(_Player)
AND
DB_CrimeAttitudeChange("Assault",_Change)
THEN
ProcCrimeCheckIfAttitudeCauseCombat(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,_Player,_Change);
DB_RC_DW_MeistrAttackedOnGallows(1);
DB_RC_DW_Meistr_Murderer(_Player);
ObjectSetFlag(_Player,"GLO_PathOfBlood_MurderedInnocent");

//Firstreceived damage is because of 
IF
CharacterReceivedDamage(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d, _, _)
AND
DB_RC_DW_MeistrAttackedOnGallows(2)
THEN
DB_RC_DW_MeistrAttackedOnGallows(3);

IF
CharacterReceivedDamage(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d, _, _)
THEN
DB_RC_DW_MeistrAttackedOnGallows(2);

IF
DB_RC_DW_MeistrAttackedOnGallows(1)
AND
DB_RC_DW_MeistrAttackedOnGallows(3)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Rescued")
THEN
CharacterSetImmortal(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0);
CharacterDie(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,1,"");
Proc_TryMeistrMurderCrime();

PROC
Proc_TryMeistrMurderCrime()
AND
DB_RC_DW_Meistr_Murderer(_Player)
AND
GetPosition(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,_x,_y,_z)
AND
RealSum(_y,1.0,_yUp)
AND
CrimeGetNewID(_CrimeID)
THEN
NOT DB_RC_DW_Meistr_Murderer(_Player);
CharacterRegisterCrimeWithPosition(_Player,"Murder",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,_x,_yUp,_z,_CrimeID);
//END_REGION

//REGION Meistr home approach
IF
CharacterUsedItemFailed(_Player,ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d)
THEN
Proc_StartDialog(0,"RC_DW_Meistr_HouseDoor",ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d,_Player);
UserSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_DoorSealed");

IF
GlobalFlagSet("RC_DW_Meistr_BreakSeal")
THEN
ItemSetOnlyOwnerCanUse(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d,0);
ItemClearOwner(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
ItemUnlockAndOpen(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
SetOnStage(ITEMGUID_S_RC_DW_Meistr_House_Notice_9ab791f4-14d0-453d-9522-f026fe26181c,0);

IF
DialogEnded("RC_DW_Meistr_HouseDoor",_Inst)
AND
QRY_SpeakerIsAvailable(CHARACTERGUID_S_RC_DW_Meistr_Kid_43e646a7-f18b-4738-92d5-c82bcd21d293)
AND
DB_DialogPlayers(_Inst,_Player,_)
AND
GetDistanceTo(_Player, CHARACTERGUID_S_RC_DW_Meistr_Kid_43e646a7-f18b-4738-92d5-c82bcd21d293, _Dist)
AND
_Dist < 10.0
AND
ObjectGetFlag(_Player,"RC_DW_Meistr_Kid_HasMet",0)
AND
QueryOnlyOnce("RC_DW_Meistr_Kid_RespondsToDoor")
THEN
ObjectSetFlag(CHARACTERGUID_S_RC_DW_Meistr_Kid_43e646a7-f18b-4738-92d5-c82bcd21d293,"RC_DW_Meistr_TriedUpstairsDoor");
Proc_Startdialog(0,"RC_DW_Meistr_Kid",CHARACTERGUID_S_RC_DW_Meistr_Kid_43e646a7-f18b-4738-92d5-c82bcd21d293, _Player);

IF
DialogEnded("RC_DW_Meistr_Kid",_)
THEN
ObjectClearFlag(CHARACTERGUID_S_RC_DW_Meistr_Kid_43e646a7-f18b-4738-92d5-c82bcd21d293,"RC_DW_Meistr_TriedUpstairsDoor",0);
//END_REGION

//REGION Meistr inside ground level
IF
StoryEvent(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_MeistrRunHome")
THEN
CharacterSetImmortal(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0);
DB_Dialogs(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_House");
SetCanFight(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,1);
SetCanJoinCombat(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,1);
CharacterSetCanTrade(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,1);
CharacterSetHitpointsPercentage(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,100.0);
DB_RC_DW_Meistr_TalkToHomeEnterers(1);
SetVarObject(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Seat",ITEMGUID_S_RC_DW_Meistr_House_Chair_ab253d51-6d69-4f47-91cd-ff1c43f9a406);
SetVarFixedString(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"SitAnimationOverride","");
DB_TriggerSendsSpotEvents(TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a);
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a);
ProcTriggerRegisterForPlayers(TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a);
GlobalSetFlag("RC_DW_Meistr_AtHome");

IF
DB_Event_CharacterAppearedInSpotTrigger(_Player,TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a)
AND
DB_RC_DW_Meistr_TalkToHomeEnterers(1)
THEN
NOT DB_RC_DW_Meistr_TalkToHomeEnterers(1);
NOT DB_TriggerSendsSpotEvents(TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a);
Proc_StartDialog(0,"RC_DW_Meistr_House",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,_Player);

IF
DialogEnded("RC_DW_Meistr_House",_)
THEN
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
DB_Dialogs(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_Vault_Guide");
DB_RC_DW_Meistr_House_Vault_Guide(1);

//Meistr instructions: Painting still in place
IF
DialogEnded("RC_DW_Meistr_House",_)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_House_ButtonShowing")
THEN
Proc_StartDialog(1,"RC_DW_AD_Meistr_House_Guide_Painting",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d); //AD: In the corner, there's a painting. Behind it is a button. Please remove the painting and press the button.

IF
GlobalFlagSet("RC_DW_Meistr_House_ButtonShowing")
AND
DB_RC_DW_Meistr_House_Vault_Guide(1)
THEN
Proc_StartDialog(1,"RC_DW_AD_Meistr_House_Guide_Button1",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d); //AD: Great, now press the button on the wall.

//Meistr instructions: Painting gone, but button unpressed
IF
DialogEnded("RC_DW_Meistr_House",_)
AND
DB_GlobalFlag("RC_DW_Meistr_House_ButtonShowing")
AND
NOT DB_GlobalFlag("RC_DW_Meistr_House_VaultShowing")
THEN
Proc_StartDialog(1,"RC_DW_AD_Meistr_House_Guide_Button2",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d); //AD: In the corner there's a button on the wall. Press it please.

IF
GlobalFlagSet("RC_DW_Meistr_House_VaultShowing")
AND
DB_RC_DW_Meistr_House_Vault_Guide(1)
THEN
Proc_StartDialog(1,"RC_DW_AD_Meistr_House_Guide_Vault1",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d); //AD: Your instruction-following prowess fills me with pride. Now go to the vault and enter the following combination.
Proc_RC_DW_Meistr_InRangeLearnSafeCombo();
//Meistr instructions: Vault revealed but still locked
IF
DialogEnded("RC_DW_Meistr_House",_)
AND
DB_GlobalFlag("RC_DW_Meistr_House_VaultShowing")
AND
NOT DB_GlobalFlag("RC_DW_Meistr_VaultUnlocked")
THEN
Proc_StartDialog(1,"RC_DW_AD_Meistr_House_Guide_Vault2",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d); //AD: In the corner you'll find a floor safe. Enter the following combination.
Proc_RC_DW_Meistr_InRangeLearnSafeCombo();

PROC
Proc_RC_DW_Meistr_InRangeLearnSafeCombo()
AND
DB_InRegion(_Player,TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a)
THEN
ObjectSetFlag(_Player,"RC_DW_Meistr_Vault_HasSafeCombo");

//Meistr instructions: Vault unlocked
IF
DialogEnded("RC_DW_Meistr_Vault",_Inst)
AND
DB_GlobalFlag("RC_DW_Meistr_VaultUnlocked")
AND
DB_RC_DW_Meistr_House_Vault_Guide(1)
THEN
NOT DB_RC_DW_Meistr_TalkToHomeEnterers(1);
NOT DB_TriggerSendsSpotEvents(TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a);
DB_RC_DW_Meistr_House_Use_Vault(1);

IF
DialogEnded("RC_DW_Meistr_House",_)
AND
DB_GlobalFlag("RC_DW_Meistr_VaultUnlocked")
THEN
DB_RC_DW_Meistr_House_Use_Vault(1);

IF
DB_RC_DW_Meistr_House_Use_Vault(1)
AND
NOT DB_DialogNPCs(_,CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,_)
AND
NOT DB_CombatCharacters(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,_)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_House_GuideCellar")
AND
CharacterIsInCombat(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0)
THEN
Proc_Meistr_ADFallback();
SetHasDialog(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0);
ClearVarObject(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Seat");
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,0,"RC_DW_Meistr_AtCellarHatch");
GlobalSetFlag("RC_DW_Meistr_House_GuideCellar");


PROC
Proc_Meistr_ADFallback()
AND
NOT QRY_StartDialog(1,"RC_DW_AD_Meistr_House_Guide_Cellar",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d) //AD: The vault is open, meet me downstairs
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,0,"RC_DW_Meistr_TeleportToCellar");

IF
AutomatedDialogEnded("RC_DW_AD_Meistr_House_Guide_Cellar",_ID)
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,0,"RC_DW_Meistr_TeleportToCellar");

IF
AutomatedDialogRequestFailed("RC_DW_AD_Meistr_House_Guide_Cellar",_ID)
THEN
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,0,"RC_DW_Meistr_TeleportToCellar");

IF
StoryEvent(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_TeleportToCellar")
THEN
NOT DB_RC_DW_Meistr_House_Vault_Guide(1);
TeleportTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,S_RC_DW_Meistr_Cellar_Entrance_805280c0-91ed-4899-a4e5-989452f5469f);
ProcCharacterMoveTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,S_RC_DW_Meistr_Cellar_Chair_b5ef08d8-fe40-48a6-bf78-b74f7466ac3a,0,"RC_DW_Meistr_TeleportToCellar2");
GlobalSetFlag("RC_DW_Meistr_AtCellar");

PROC
ProcBlockUseOfItem(_Player,ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_VaultUnlocked")
THEN
DB_CustomUseItemResponse(_Player,ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,0);
Proc_StartDialog(0,"RC_DW_Meistr_Vault",ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,_Player);

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a)
AND
QueryOnlyOnce("RC_DW_VB_Meistr_HouseTossed")
THEN
StartVoiceBark("RC_DW_VB_Meistr_HouseTossed",_Player);

IF
DialogEnded("RC_DW_Meistr_Vault",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,1)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Rescued")
AND
CharacterIsDead(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0)
AND
QueryOnlyOnce("RC_DW_VB_Meistr_House_ShouldRescueMeistr")
THEN
StartVoiceBark("RC_DW_VB_Meistr_House_ShouldRescueMeistr",(CHARACTERGUID)_Player);

IF
ItemMoved(S_RC_DW_Meistr_House_Painting_c8a18f2c-c2b9-4e4c-872b-70c9cd0bb165)
THEN
SetOnStage(ITEMGUID_S_RC_DW_Meistr_House_Button_e53dceb1-9ce1-464d-a1bd-4c3ee2ed8a10,1);
GlobalSetFlag("RC_DW_Meistr_House_ButtonShowing");
PlayEffect(ITEMGUID_S_RC_DW_Meistr_House_Button_e53dceb1-9ce1-464d-a1bd-4c3ee2ed8a10,"RS3_FX_UI_PerceptionReveal_01_NotLooping");


IF
ItemAddedToCharacter(S_RC_DW_Meistr_House_Painting_c8a18f2c-c2b9-4e4c-872b-70c9cd0bb165,_)
THEN
SetOnStage(ITEMGUID_S_RC_DW_Meistr_House_Button_e53dceb1-9ce1-464d-a1bd-4c3ee2ed8a10,1);
GlobalSetFlag("RC_DW_Meistr_House_ButtonShowing");
PlayEffect(ITEMGUID_S_RC_DW_Meistr_House_Button_e53dceb1-9ce1-464d-a1bd-4c3ee2ed8a10,"RS3_FX_UI_PerceptionReveal_01_NotLooping");

IF
ItemDestroyed(S_RC_DW_Meistr_House_Painting_c8a18f2c-c2b9-4e4c-872b-70c9cd0bb165)
THEN
SetOnStage(ITEMGUID_S_RC_DW_Meistr_House_Button_e53dceb1-9ce1-464d-a1bd-4c3ee2ed8a10,1);
GlobalSetFlag("RC_DW_Meistr_House_ButtonShowing");
PlayEffect(ITEMGUID_S_RC_DW_Meistr_House_Button_e53dceb1-9ce1-464d-a1bd-4c3ee2ed8a10,"RS3_FX_UI_PerceptionReveal_01_NotLooping");

IF
CharacterUsedItem(_Player,ITEMGUID_S_RC_DW_Meistr_House_Button_e53dceb1-9ce1-464d-a1bd-4c3ee2ed8a10)
AND
GlobalGetFlag("RC_DW_Meistr_House_VaultShowing",0)
THEN
proc_ItemMoveToTrigger(ITEMGUID_S_RC_DW_Meistr_House_Bed_2df759f6-3b83-433d-9bee-750eb2225b2e,TRIGGERGUID_S_RC_DW_Meistr_House_BedReveal_07d4b368-2462-43e0-8e5d-e7d0e79428a2,1.0,0.0,1);
SetOnStage(ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,1);
GlobalSetFlag("RC_DW_Meistr_House_VaultShowing");

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 6, 0, 1)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_House_VaultShowing")
THEN
SetOnStage(ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,0);

IF
CharacterDied(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d)
THEN
Proc_PurgeLevelPartyFlag("RC_DW_Meistr_House_MeistrGivesYouCode");
//END_REGION

//REGION Cellar
IF
GlobalFlagSet("RC_DW_Meistr_VaultUnlocked")
THEN
PlaySound(ITEMGUID_S_RC_DW_Meistr_Vault_490008a4-9a57-410c-be1e-8dd1c422375d,"SE_RC_TheMeistr_HatchUnlock");

IF
StoryEvent(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_TeleportToCellar2")
THEN
SetVarObject(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Seat",S_RC_DW_Meistr_Cellar_Chair_b5ef08d8-fe40-48a6-bf78-b74f7466ac3a);
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
DB_Dialogs(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_Artefact_Guide");
ProcTriggerUnregisterForPlayers(TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a);

IF
StoryEvent(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_TeleportToCellar2")
AND
DB_InRegion(_Player,TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c)
AND
DB_IsPlayer(_Player)
AND
QueryOnlyOnce("RC_DW_AD_Meistr_Cellar_ComeTalkToMe")
THEN
Proc_StartDialog(1,"RC_DW_AD_Meistr_Cellar_ComeTalkToMe",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);

IF
GameBookInterfaceClosed(S_RC_DW_Meistr_RitualBook_45f6f949-dae8-4dce-a1e3-e65bbf40d276,_Player)
THEN
PartySetFlag(_Player,"RC_DW_Meistr_KnowsAboutRitual");
UserSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_BookRead",0);


IF
ObjectFlagSet("RC_DW_Meistr_GiveRitualIngredients",_Player,_)
THEN
ItemTemplateAddTo("QUEST_Blackroot_843689bf-6498-45ac-98ba-b375bdbbb189",_Player,1);
ItemTemplateAddTo("QUEST_Lancet_ccc5d336-6349-4fe3-bcea-4758764f005f",_Player,1);
ItemTemplateAddTo("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_Player,1);

IF
ObjectFlagSet("RC_DW_Meistr_GiveRitualIngredientsAgain",_Player,_)
THEN
ItemTemplateAddTo("QUEST_Lancet_ccc5d336-6349-4fe3-bcea-4758764f005f",_Player,1);
ItemTemplateAddTo("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_Player,1);
ObjectClearFlag(_Player,"RC_DW_Meistr_GiveRitualIngredientsAgain");

IF
CharacterUsedItemTemplate(_Player,"QUEST_Lancet_ccc5d336-6349-4fe3-bcea-4758764f005f",_Item)
AND
IsTagged(_Player,"UNDEAD",0)
THEN
ApplyDamage(_Player,1,"Physical");
ItemRemove(_Item);
ItemTemplateAddTo("QUEST_Lancet_Bloody_6b7c3f74-0158-414e-bfc7-8a5f777b52bc",_Player,1);

IF
CharacterUsedItemTemplate(_Player,"QUEST_Lancet_ccc5d336-6349-4fe3-bcea-4758764f005f",_Item)
AND
IsTagged(_Player,"UNDEAD",1)
THEN
ApplyDamage(_Player,1,"Physical");
ItemRemove(_Item);
ItemTemplateAddTo("QUEST_Lancet_Marrow_9317289d-4215-4a73-ba80-43fe0bcba0ad",_Player,1);



// Check all burning statuses

IF
ItemStatusChange(_RitualBowl,"BURNING",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
NOT QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
AND
CreateItemTemplateAtPosition("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_X,_Y,_Z,_EmptyBowl)
THEN
ItemRemove(_RitualBowl);
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

IF
ItemStatusChange(_RitualBowl,"BurningA",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
NOT QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
AND
CreateItemTemplateAtPosition("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_X,_Y,_Z,_EmptyBowl)
THEN
ItemRemove(_RitualBowl);
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

IF
ItemStatusChange(_RitualBowl,"BurningB",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
NOT QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
AND
CreateItemTemplateAtPosition("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_X,_Y,_Z,_EmptyBowl)
THEN
ItemRemove(_RitualBowl);
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

IF
ItemStatusChange(_RitualBowl,"BurningC",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
NOT QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
AND
CreateItemTemplateAtPosition("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_X,_Y,_Z,_EmptyBowl)
THEN
ItemRemove(_RitualBowl);
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

IF
ItemStatusChange(_RitualBowl,"BurningD",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
NOT QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
AND
CreateItemTemplateAtPosition("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_X,_Y,_Z,_EmptyBowl)
THEN
ItemRemove(_RitualBowl);
DB_RC_DW_Meistr_BowlBurningE((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

IF
ItemStatusChange(_RitualBowl,"BurningE",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
NOT QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
AND
CreateItemTemplateAtPosition("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_X,_Y,_Z,_EmptyBowl)
THEN
ItemRemove(_RitualBowl);
DB_RC_DW_Meistr_BowlBurningG((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

IF
ItemStatusChange(_RitualBowl,"BurningF",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
NOT QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
AND
CreateItemTemplateAtPosition("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_X,_Y,_Z,_EmptyBowl)
THEN
ItemRemove(_RitualBowl);
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

IF
ItemStatusChange(_RitualBowl,"BurningG",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
NOT QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
AND
CreateItemTemplateAtPosition("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_X,_Y,_Z,_EmptyBowl)
THEN
ItemRemove(_RitualBowl);
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

IF
ItemStatusChange(_RitualBowl,"BurningH",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
NOT QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl,_X,_Y,_Z)
AND
CreateItemTemplateAtPosition("RS3_FX_HallucinogenicSmoke_01_9a6b7b5b-83eb-49f4-945c-afa13a8305b7",_X,_Y,_Z,_Portal)
AND
CreateItemTemplateAtPosition("QUEST_AtaraxianBowl_60126343-6565-44a2-a00f-8f6e63f8af97",_X,_Y,_Z,_EmptyBowl)
THEN
ItemRemove(_RitualBowl);
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal);
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);

//



// Check all burning statuses

IF
ItemStatusChange(_RitualBowl,"BURNING",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
THEN
RemoveStatus(_RitualBowl, "BURNING");
//TODO Patch 1: sad smoke poof.

IF
ItemStatusChange(_RitualBowl,"BurningA",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
THEN
RemoveStatus(_RitualBowl, "BurningA");
//TODO Patch 1: sad smoke poof.

IF
ItemStatusChange(_RitualBowl,"BurningB",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
THEN
RemoveStatus(_RitualBowl, "BurningB");
//TODO Patch 1: sad smoke poof.

IF
ItemStatusChange(_RitualBowl,"BurningC",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
THEN
RemoveStatus(_RitualBowl, "BurningC");
//TODO Patch 1: sad smoke poof.

IF
ItemStatusChange(_RitualBowl,"BurningD",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
THEN
RemoveStatus(_RitualBowl, "BurningD");
//TODO Patch 1: sad smoke poof.

IF
ItemStatusChange(_RitualBowl,"BurningE",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
THEN
RemoveStatus(_RitualBowl, "BurningE");
//TODO Patch 1: sad smoke poof.

IF
ItemStatusChange(_RitualBowl,"BurningF",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
THEN
RemoveStatus(_RitualBowl, "BurningF");
//TODO Patch 1: sad smoke poof.

IF
ItemStatusChange(_RitualBowl,"BurningG",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
THEN
RemoveStatus(_RitualBowl, "BurningG");
//TODO Patch 1: sad smoke poof.

IF
ItemStatusChange(_RitualBowl,"BurningH",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
THEN
RemoveStatus(_RitualBowl, "BurningH");
//TODO Patch 1: sad smoke poof.

//



// Check all burning statuses

IF
ItemStatusChange(_RitualBowl,"BURNING",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl, _X, _Y, _Z)
THEN
CreateSurfaceAtPosition(_X, _Y, _Z, "SurfaceNone", 1.0, -1.0);

IF
ItemStatusChange(_RitualBowl,"BurningA",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl, _X, _Y, _Z)
THEN
CreateSurfaceAtPosition(_X, _Y, _Z, "SurfaceNone", 1.0, -1.0);

IF
ItemStatusChange(_RitualBowl,"BurningB",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl, _X, _Y, _Z)
THEN
CreateSurfaceAtPosition(_X, _Y, _Z, "SurfaceNone", 1.0, -1.0);

IF
ItemStatusChange(_RitualBowl,"BurningC",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl, _X, _Y, _Z)
THEN
CreateSurfaceAtPosition(_X, _Y, _Z, "SurfaceNone", 1.0, -1.0);

IF
ItemStatusChange(_RitualBowl,"BurningD",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl, _X, _Y, _Z)
THEN
CreateSurfaceAtPosition(_X, _Y, _Z, "SurfaceNone", 1.0, -1.0);

IF
ItemStatusChange(_RitualBowl,"BurningE",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl, _X, _Y, _Z)
THEN
CreateSurfaceAtPosition(_X, _Y, _Z, "SurfaceNone", 1.0, -1.0);

IF
ItemStatusChange(_RitualBowl,"BurningF",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl, _X, _Y, _Z)
THEN
CreateSurfaceAtPosition(_X, _Y, _Z, "SurfaceNone", 1.0, -1.0);

IF
ItemStatusChange(_RitualBowl,"BurningG",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl, _X, _Y, _Z)
THEN
CreateSurfaceAtPosition(_X, _Y, _Z, "SurfaceNone", 1.0, -1.0);

IF
ItemStatusChange(_RitualBowl,"BurningH",_)
AND
GetTemplate(_RitualBowl,"QUEST_AtaraxianBowl_Ready_eec074a6-025b-4740-abe6-00696ef41e66")
AND
QRY_RC_DW_RitualBowlBlocked(_RitualBowl)
AND
GetPosition(_RitualBowl, _X, _Y, _Z)
THEN
CreateSurfaceAtPosition(_X, _Y, _Z, "SurfaceNone", 1.0, -1.0);

//




QRY
QRY_RC_DW_RitualBowlBlocked((ITEMGUID)_RitualBowl)
AND
DB_PyramidBlockerTrigger(_Trigger)
AND
ObjectIsInTrigger(_RitualBowl, _Trigger, 1)
THEN
DB_NOOP(0);

PROC
ProcObjectTimerFinished((ITEMGUID)_Portal,"RC_DW_Meistr_SmokePortal_Gone")
AND
DB_RC_DW_Meistr_BowlBurning((ITEMGUID)_Portal)
AND
DB_IsPlayer(_Player)
AND
NOT DB_RC_DW_Meistr_SomeoneNearPortal(_Portal)
AND
NOT DB_RC_DW_Meistr_NonControlledInDream(_Player)
AND
GetDistanceTo(_Player,_Portal,_Dist)
AND
_Dist < 30
THEN
ProcObjectTimer(_Portal,"RC_DW_Meistr_SmokePortal_Gone",5000);
DB_RC_DW_Meistr_SomeoneNearPortal(_Portal);

PROC
ProcObjectTimerFinished((ITEMGUID)_Portal,"RC_DW_Meistr_SmokePortal_Gone")
AND
NOT DB_RC_DW_Meistr_SomeoneNearPortal(_Portal)
THEN
ProcRemoveAllDialogEntriesForSpeaker(_Portal);
ItemRemove(_Portal);
NOT DB_RC_DW_Meistr_BowlBurning(_Portal);

PROC
ProcObjectTimerFinished((ITEMGUID)_Portal,"RC_DW_Meistr_SmokePortal_Gone")
AND
NOT DB_RC_DW_Meistr_SomeoneNearPortal(_Portal)
AND
DB_RC_DW_Meistr_PlayerUsedSmoke(_Player,_Portal)
THEN
ProcRemoveAllDialogEntriesForSpeaker(_Portal);
ItemRemove(_Portal);
NOT DB_RC_DW_Meistr_BowlBurning(_Portal);
NOT DB_RC_DW_Meistr_PlayerUsedSmoke(_Player,_Portal);

PROC
ProcObjectTimerFinished((ITEMGUID)_Portal,"RC_DW_Meistr_SmokePortal_Gone")
THEN
NOT DB_RC_DW_Meistr_SomeoneNearPortal(_Portal);
//END_REGION

//REGION Going through the portal
IF
CharacterEnteredTrigger(_Player,S_RC_DW_Meistr_DreamScene_f206d532-488e-469f-bb2a-5fb4270aa438)
THEN
PROC_BlockWaypointUsage(_Player);
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_HallOfEchoes");


IF
CharacterLeftTrigger(_Player,S_RC_DW_Meistr_DreamScene_f206d532-488e-469f-bb2a-5fb4270aa438)
THEN
PROC_UnblockWaypointUsage(_Player);


IF
CharacterUsedItem(_Player,_SmokePortal)
AND
DB_RC_DW_Meistr_BowlBurning(_SmokePortal)
THEN
ObjectClearFlag(_Player,"RC_DW_Meistr_CanGoToDream",0);

IF
CharacterUsedItem(_Player,_SmokePortal)
AND
DB_RC_DW_Meistr_BowlBurning(_SmokePortal)
AND
ObjectGetFlag(_Player,"RC_DW_Meistr_KnowCoS",0)
AND
GetRegion(_Player,"RC_Main")
THEN
ObjectSetFlag(_Player,"RC_DW_Meistr_CanGoToDream");

IF
CharacterUsedItem(_Player,_SmokePortal)
AND
DB_RC_DW_Meistr_BowlBurning(_SmokePortal)
AND
IsTagged(_Player,"AVATAR",0)
AND
DB_IsPlayer(_Avatar)
AND
IsTagged(_Avatar,"AVATAR",1)
AND
QRY_SpeakerIsAvailable(_Avatar)
AND
QRY_SpeakerIsAvailable(_SmokePortal)
AND
GetDistanceTo(_Avatar,_SmokePortal,_Dist)
AND
_Dist < 15
AND
CharacterGetSourcePoints(_Avatar,_Amount)
THEN
Proc_SetConditionalObjectFlag(_Avatar,"RC_DW_Meistr_HasOneSourcePoint",_Amount);
Proc_StartDialog(0,"RC_DW_Meistr_Artefact",_Avatar);
DB_RC_DW_Meistr_Artefact_Started(_SmokePortal);

IF
CharacterUsedItem(_Player,_SmokePortal)
AND
DB_RC_DW_Meistr_BowlBurning(_SmokePortal)
AND
IsTagged(_Player,"AVATAR",1)
AND
QRY_SpeakerIsAvailable(_SmokePortal)
AND
CharacterGetSourcePoints(_Player,_Amount)
THEN
Proc_SetConditionalObjectFlag(_Player,"RC_DW_Meistr_HasOneSourcePoint",_Amount);
Proc_StartDialog(0,"RC_DW_Meistr_Artefact",_Player);
DB_RC_DW_Meistr_Artefact_Started(_SmokePortal);
DB_RC_DW_Meistr_PlayerUsedSmoke(_Player,_SmokePortal);

IF
CharacterUsedItem(_Player,_SmokePortal)
AND
DB_RC_DW_Meistr_BowlBurning(_SmokePortal)
AND
NOT DB_RC_DW_Meistr_Artefact_Started(_SmokePortal)
THEN
//ApplyStatus(_Player,"SLEEPING",15.0,1);
// What to make this?
ApplyStatus(_Player,"SleepingH",15.0,1);

IF
CharacterUsedItem(_Player,_SmokePortal)
AND
DB_RC_DW_Meistr_Artefact_Started(_SmokePortal)
THEN
NOT DB_RC_DW_Meistr_Artefact_Started(_SmokePortal);

IF
ObjectFlagSet("RC_DW_Meistr_EnterDreamScene",(CHARACTERGUID)_Player,_)
THEN
DB_RC_DW_Meistr_TeleportToDreamScene(_Player);
ObjectClearFlag(_Player,"RC_DW_Meistr_EnterDreamScene",0);

IF
DialogEnded("RC_DW_Meistr_Artefact",_Inst)
AND
DB_RC_DW_Meistr_TeleportToDreamScene(_Player)
AND
CharacterIsControlled(_Player,1)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_,_)
AND
NOT DB_RC_DW_Meistr_Dream_AssignedChamber(_Player,_)
AND
NOT DB_RC_DW_Meistr_Dream_AssignedChamber(_,_Trigger)
THEN
DB_RC_DW_Meistr_Dream_AssignedChamber(_Player,_Trigger);

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream(_Player,_,_)
AND
DB_IsPlayer(_Companion)
AND
NOT DB_Avatars(_Companion)
AND
CharacterIsControlled(_Companion,0)
AND
CharacterIsInPartyWith(_Player,_Companion,1)
AND
GetDistanceTo(_Player,_Companion,_Dist)
AND
_Dist < 30.0
THEN
//ApplyStatus(_Companion,"SLEEPING",15.0,1);
// What to make this?
ApplyStatus(_Companion,"SleepingH",15.0,1);
DB_RC_DW_Meistr_NonControlledInDream(_Companion);
NOT DB_RC_DW_Meistr_TeleportToDreamScene(_Companion);

IF
DialogEnded("RC_DW_Meistr_Artefact",_Inst)
AND
DB_RC_DW_Meistr_TeleportToDreamScene(_Player)
AND
CharacterIsControlled(_Player,1)
AND
DB_RC_DW_Meistr_Dream_AssignedChamber(_Player,_Trigger)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_Portal,_God)
AND
GetPosition(_Player,_X,_Y,_Z)
THEN
NOT DB_RC_DW_Meistr_TeleportToDreamScene(_Player);
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,_Player,_X,_Y,_Z);
CharacterDetachFromGroup((CHARACTERGUID)_Player);
PlayEffect(_Player,"RS3_FX_GP_ScriptedEvent_HOE_Summoning_01");
RemoveStatus(_Player, "BURNING");
RemoveStatus(_Player, "BurningA",_)
RemoveStatus(_Player, "BurningB",_)
RemoveStatus(_Player, "BurningC",_)
RemoveStatus(_Player, "BurningD",_)
RemoveStatus(_Player, "BurningE",_)
RemoveStatus(_Player, "BurningF",_)
RemoveStatus(_Player, "BurningG",_)
RemoveStatus(_Player, "BurningH",_)
RemoveStatus(_Player, "POISON");
RemoveStatus(_Player, "PoisonedA");
RemoveStatus(_Player, "PoisonedB");
RemoveStatus(_Player, "PoisonedC");
RemoveStatus(_Player, "PoisonedD");
RemoveStatus(_Player, "PoisonedE");
RemoveStatus(_Player, "PoisonedF");
RemoveStatus(_Player, "PoisonedG");
RemoveStatus(_Player, "PoisonedH");
RemoveStatus(_Player, "BLEEDING");
RemoveStatus(_Player, "BleedingA");
RemoveStatus(_Player, "BleedingB");
RemoveStatus(_Player, "BleedingC");
RemoveStatus(_Player, "BleedingD");
RemoveStatus(_Player, "BleedingE");
RemoveStatus(_Player, "BleedingF");
RemoveStatus(_Player, "BleedingG");
RemoveStatus(_Player, "BleedingH");
RemoveStatus(_Player, "NECROFIRE");
RemoveStatus(_Player, "ACID");
RemoveStatus(_Player, "AcidA");
RemoveStatus(_Player, "AcidB");
RemoveStatus(_Player, "AcidC");
RemoveStatus(_Player, "AcidD");
RemoveStatus(_Player, "AcidE");
RemoveStatus(_Player, "AcidF");
RemoveStatus(_Player, "AcidG");
RemoveStatus(_Player, "AcidH");
Proc_RemoveSourcePoints(_Player);
ProcRemovePolymorphsFromPlayer(_Player);
Proc_RC_DW_Meistr_PlayerEnteredDream(_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God);
TeleportTo(_Player,_Trigger);


IF
DialogEnded("RC_DW_Meistr_Artefact",_Inst)
AND
DB_RC_DW_Meistr_TeleportToDreamScene(_Companion)
AND
IsTagged(_Companion,"AVATAR",0)
THEN
//ApplyStatus(_Companion,"SLEEPING",15.0,1);
// What to make this?
ApplyStatus(_Companion,"SleepingH",15.0,1);
DB_RC_DW_Meistr_NonControlledInDream(_Companion);
NOT DB_RC_DW_Meistr_TeleportToDreamScene(_Companion);

IF
DialogEnded("RC_DW_Meistr_Artefact",_Inst)
AND
DB_RC_DW_Meistr_TeleportToDreamScene(_Companion)
THEN
NOT DB_RC_DW_Meistr_TeleportToDreamScene(_Companion);

IF
CharacterDied(_Player)
AND
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,_Player,_,_,_)
THEN
TeleportTo(_Player,_Trigger);
CharacterResurrect(_Player);

IF
CharacterResurrected(_Player)
AND
DB_RC_DB_Meistr_Dream_Occupied(_,_Player,_,_,_)
THEN
ApplyStatus(_Player,"INVULNERABLE",12.0,1);
//END_REGION

//REGION Journal Update LackOfSource

IF
ObjectFlagSet("RC_DW_Meistr_LackOfSource_Generic",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_2SP",0)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_3SP",0)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_LackOfSource");
UserClearFlag(_Player,"RC_DW_Meistr_LackOfSource_Generic",0);

IF
ObjectFlagSet("RC_DW_Meistr_LackOfSource_Generic",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_2SP",1)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_3SP",0)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_LackOfSource2SP");
UserClearFlag(_Player,"RC_DW_Meistr_LackOfSource_Generic",0);

IF
ObjectFlagSet("RC_DW_Meistr_LackOfSource_Generic",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_2SP",1)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_3SP",1)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_LackOfSource3SP");
UserClearFlag(_Player,"RC_DW_Meistr_LackOfSource_Generic",0);

//END_REGION

//REGION Prepare God
IF
DB_RC_DB_Meistr_Dream_Voidwoken(_God,_Voidwoken)
THEN
SetOnStage(_Voidwoken,0);

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
NOT DB_RC_DW_Meistr_PreppedDreamGod(_Player)
AND
QRY_RC_DW_Meistr_IsRealLohse(_Player)
THEN
ProcCharacterDisableAllCrimes(_God);
CharacterTransformAppearanceTo(_God,_Player,1,1);
DB_RC_DW_Meistr_GodDialog(_God,1,"RC_DW_Meistr_Dream_Puzzle1_Lohse");
DB_RC_DW_Meistr_GodDialog(_God,2,"RC_DW_Meistr_Dream_Puzzle2_Lohse");
DB_RC_DW_Meistr_GodDialog(_God,3,"RC_DW_Meistr_Dream_Puzzle3_Lohse");
DB_RC_DW_Meistr_GodToTransformInto(_God,"QUEST_HoE_Lohse_e4305b97-4ec2-43c2-b2a9-994b1df35636");

QRY
QRY_RC_DW_Meistr_IsRealLohse((CHARACTERGUID)_Player)
AND
IsTagged(_Player,"LOHSE",1)
THEN
DB_NOOP(1);

QRY
QRY_RC_DW_Meistr_IsRealLohse((CHARACTERGUID)_Player)
AND
IsTagged(_Player,"SHAPESHIFT_LOHSE",1)
THEN
DB_NOOP(1);

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
NOT DB_RC_DW_Meistr_PreppedDreamGod(_Player)
AND
QRY_IsTrueRace(_Player,"Human")
AND
NOT QRY_RC_DW_Meistr_IsRealLohse(_Player)
THEN
CharacterTransformAppearanceTo(_God,_Player,1,1);
DB_RC_DW_Meistr_GodDialog(_God,1,"RC_DW_Meistr_Dream_Puzzle1_Ifan");
DB_RC_DW_Meistr_GodDialog(_God,2,"RC_DW_Meistr_Dream_Puzzle2_Ifan");
DB_RC_DW_Meistr_GodDialog(_God,3,"RC_DW_Meistr_Dream_Puzzle3_Ifan");
DB_RC_DW_Meistr_GodToTransformInto(_God,"QUEST_HoE_Rhalic_b456c9bb-2eb1-4130-8ea7-4a6185c75b7f");

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
QRY_IsTrueRace(_Player,"Lizard")
AND
NOT DB_RC_DW_Meistr_PreppedDreamGod(_Player)
THEN
CharacterTransformAppearanceTo(_God,_Player,1,1);
DB_RC_DW_Meistr_GodDialog(_God,1,"RC_DW_Meistr_Dream_Puzzle1_RedPrince");
DB_RC_DW_Meistr_GodDialog(_God,2,"RC_DW_Meistr_Dream_Puzzle2_RedPrince");
DB_RC_DW_Meistr_GodDialog(_God,3,"RC_DW_Meistr_Dream_Puzzle3_RedPrince");
DB_RC_DW_Meistr_GodToTransformInto(_God,"QUEST_HoE_ZorlStissa_222c6936-b1d2-479e-af9a-ef26316f3b95");

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
QRY_IsTrueRace(_Player,"Elf")
AND
NOT DB_RC_DW_Meistr_PreppedDreamGod(_Player)
THEN
CharacterTransformAppearanceTo(_God,_Player,1,1);
DB_RC_DW_Meistr_GodDialog(_God,1,"RC_DW_Meistr_Dream_Puzzle1_Sebille");
DB_RC_DW_Meistr_GodDialog(_God,2,"RC_DW_Meistr_Dream_Puzzle2_Sebille");
DB_RC_DW_Meistr_GodDialog(_God,3,"RC_DW_Meistr_Dream_Puzzle3_Sebille");
DB_RC_DW_Meistr_GodToTransformInto(_God,"QUEST_HoE_TirCendelius_a517d970-44ce-496d-89f0-bd0157a6fdce");

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
QRY_IsTrueRace(_Player,"Dwarf")
AND
NOT DB_RC_DW_Meistr_PreppedDreamGod(_Player)
THEN
CharacterTransformAppearanceTo(_God,_Player,1,1);
DB_RC_DW_Meistr_GodDialog(_God,1,"RC_DW_Meistr_Dream_Puzzle1_Beast");
DB_RC_DW_Meistr_GodDialog(_God,2,"RC_DW_Meistr_Dream_Puzzle2_Beast");
DB_RC_DW_Meistr_GodDialog(_God,3,"RC_DW_Meistr_Dream_Puzzle3_Beast");
DB_RC_DW_Meistr_GodToTransformInto(_God,"QUEST_HoE_Duna_71faeb33-7a9a-4cc9-a162-e78d7c122143");

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
QRY_IsTrueUndead(_Player)
AND
NOT DB_RC_DW_Meistr_PreppedDreamGod(_Player)
THEN
CharacterTransformAppearanceTo(_God,_Player,1,1);
DB_RC_DW_Meistr_GodDialog(_God,1,"RC_DW_Meistr_Dream_Puzzle1_Fane");
DB_RC_DW_Meistr_GodDialog(_God,2,"RC_DW_Meistr_Dream_Puzzle2_Fane");
DB_RC_DW_Meistr_GodDialog(_God,3,"RC_DW_Meistr_Dream_Puzzle3_Fane");
DB_RC_DW_Meistr_GodToTransformInto(_God,"QUEST_HoE_Amadia_7a80020b-40b2-42bb-8b30-63fb981340d5");
SetTag(_God,"IGNORE_UNDEAD_CRIME");

IF
DB_RC_DB_Meistr_Dream(_,_,_God)
THEN
SetVarInteger(_God,"StatusFXActive",0);

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
DB_RC_DW_Meistr_GodDialog(_God,1,_Dialog)
AND
NOT DB_RC_DW_Meistr_PreppedDreamGod(_Player)
THEN
DB_RC_DW_Meistr_PreppedDreamGod(_Player);
DB_Dialogs(_God,_Dialog);
ApplyStatus(_God,"HALL_OF_ECHOES",-1.0);
SetCanFight(_God,0);
SetCanJoinCombat(_God,0);
CharacterSetImmortal(_God,1);
ProcSetInvulnerable(_God,1);
ProcObjectTimer(_God,"RC_DW_Meistr_RemoveHelmet",1000);
ProcCharacterDisableAllCrimes(_God);

PROC
ProcObjectTimerFinished(_God,"RC_DW_Meistr_RemoveHelmet")
AND
CharacterGetEquippedItem((CHARACTERGUID)_God,"Helmet",_Helmet)
THEN
CharacterUnequipItem(_God,(ITEMGUID)_Helmet);
//END_REGION

//REGION Heist -journal updates
IF
GameBookInterfaceClosed(S_RC_DW_Meistr_Sourcererlist_bb3f2c79-5a58-4060-b337-0af65a1ef18b,_Player)
THEN
PartySetFlag(_Player,"RC_DW_Meistr_FoundListOfSourcerers");
//ProcShowMarker(_Player,"RC_GY_RykerHouse");
//ProcShowMarker(_Player,"RC_DW_WreckersCave");
//ProcShowMarker(_Player,"RC_BI_ThePresence");
//ProcShowMarker(_Player,"RC_MIL_Sawmill");
ProcShowMarker(_Player,"RC_OIL_Oilfields");
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_MordusTeacher");
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_RykerTeacher");
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_HannagTeacher");
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_DemonTeacher");
PROC_RC_DW_Meistr_SaheilaTeacher_SetUpdate(_Player);
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_CoverTheTracks_SourcererList_Start");
ObjectSetFlag(_Player,"RC_GY_RykersContract_SourcererList_Start"); //flag needed because it is checked in some quest.


IF
GameBookInterfaceClosed(S_RC_DW_Meistr_Sourcererlist_bb3f2c79-5a58-4060-b337-0af65a1ef18b,_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Heist_Meistr",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_NewTeacher");

IF
GameBookInterfaceClosed(S_RC_DW_Meistr_Sourcererlist_bb3f2c79-5a58-4060-b337-0af65a1ef18b,_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Heist_Meistr",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_NewTeacherEarly");

IF
ObjectFlagSet("QuestUpdate_RC_DW_Meistr_Heist_Meistr",_Player,_)
AND
PartyGetFlag((CHARACTERGUID)_Player,"RC_DW_Meistr_FoundListOfSourcerers",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_NewTeacher");

IF
ObjectFlagSet("RC_DW_Meistr_SaheilaTeacher_Lohar_SetUpdate",_Player,_)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Heist_Meistr",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_NewTeacherEarly");

PROC
PROC_RC_DW_Meistr_SaheilaTeacher_SetUpdate((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_SaheilaTeacher_Lohar",0)
AND
ObjectGetFlag(_Player,"FTJ_SaheilaHasMet",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_SaheilaTeacher_Hasmet");

PROC
PROC_RC_DW_Meistr_CheckTeacherUpdates((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_SaheilaTeacher_Lohar",0)
AND
ObjectGetFlag(_Player,"FTJ_SaheilaHasMet",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_SaheilaTeacher");

IF
ObjectFlagSet("RC_DW_Meistr_SaheilaTeacher_Lohar_SetUpdate",_Player,_)
AND
ObjectGetFlag(_Player,"FTJ_SaheilaHasMet",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_SaheilaTeacher_Lohar");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SaheilaFate_SaheilaAlive");

IF
ObjectFlagSet("RC_DW_Meistr_SaheilaTeacher_Lohar_SetUpdate",_Player,_)
AND
ObjectGetFlag(_Player,"FTJ_SaheilaHasMet",1)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_SaheilaTeacher_Lohar_Hasmet");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_SaheilaFate_SaheilaAlive");


IF
ObjectFlagSet("RC_DW_RykerMarkerSet",_Player,_)
THEN
ProcShowMarker((CHARACTERGUID)_Player,"RC_GY_RykerHouse");

//END_REGION

//REGION DreamScene
IF
DialogStarted(_Dialog,_ID)
AND
DB_RC_DW_Meistr_GodDialog(_,_,_Dialog)
AND
DB_DialogPlayers(_ID,_Player,1)
THEN
ProcRemovePolymorphsFromPlayer(_Player);

IF
DB_RC_DB_Meistr_Dream(_Trigger,_Portal,_God)
THEN
SetOnStage(_Portal,0);

IF
ObjectFlagSet("RC_DW_Meistr_Dream_GodVampsYou",_God,_ID)
AND
DB_DialogPlayers(_ID,_Player,1)
THEN
CharacterUseSkill((CHARACTERGUID)_God,"Target_DialogSourceVampirism",_Player, 1, 1, 1);

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
NOT DB_OnlyOncePP(_Player,"RC_DW_VB_Meistr_Dream")
THEN
DB_OnlyOncePP(_Player,"RC_DW_VB_Meistr_Dream");
StartVoiceBark("RC_DW_VB_Meistr_Dream",_Player);

PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
CharacterGetLevel(_Player,_Lvl)
THEN
CharacterLevelUpTo(_God,_Lvl);

//Final visit
PROC
Proc_RC_DW_Meistr_PlayerEnteredDream((CHARACTERGUID)_Player,(ITEMGUID)_Portal,(CHARACTERGUID)_God)
AND
ObjectGetFlag(_Player,"RC_DW_Meistr_Dream_Visit2",1)
AND
ObjectGetFlag(_Player,"GLO_Has3MaxMP",1)
AND
CharacterGetLevel(_Player,_Lvl)
AND
DB_RC_DB_Meistr_Dream_Voidwoken(_God,_Voidwoken)
THEN
CharacterLevelUpTo((CHARACTERGUID)_VoidWoken,_Lvl);
SetOnStage(_Voidwoken,1);
SetCanFight(_God,1);
SetCanJoinCombat(_God,1);

IF
CharacterUsedSkill(_Player,"Shout_SpiritVision",_,_)
AND
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,_Player,_,_,_)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_,_God)
AND
DB_Dialogs(_God,_CurrentDiag)
AND
DB_RC_DW_Meistr_GodDialog(_God,1,_CurrentDiag)
AND
DB_RC_DW_Meistr_GodDialog(_God,2,_Dialog)
THEN
ProcRemoveAllDialogEntriesForSpeaker(_God);
DB_Dialogs(_God,_Dialog);
ProcObjectTimer(_God,"RC_DW_Meistr_Dream_Transform",1000);
ProcObjectTimer(_Player,"RC_DW_Meistr_Dream_Puzzle2",2000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_God,"RC_DW_Meistr_Dream_Transform")
AND
DB_RC_DW_Meistr_GodToTransformInto(_God,_GodTemplate)
THEN
CharacterTransform(_God,_GodTemplate,1,0,0,1,1,1,1);
CharacterOverrideMaxSourcePoints(_God,3);
CharacterAddSourcePoints(_God,3);
SetStoryEvent(_God,"GEN_LoopStatusEffect_TurnOn");

PROC
ProcObjectTimerFinished((CHARACTERGUID)_God,"RC_DW_Meistr_Dream_Transform")
AND
DB_RC_DW_Meistr_GodToTransformInto(_God,_GodTemplate)
AND
DB_RC_DW_Meistr_PreppedDreamGod(_Player)
AND
QRY_RC_DW_Meistr_IsRealLohse(_Player)
AND
_GodTemplate == "QUEST_HoE_Lohse_e4305b97-4ec2-43c2-b2a9-994b1df35636"
THEN
CharacterTransformAppearanceTo(_God,_Player,1,1);

PROC
ProcObjectTimerFinished(_Player,"RC_DW_Meistr_Dream_Puzzle2")
AND
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,(CHARACTERGUID)_Player,_,_,_)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_,_God)
AND
DB_RC_DW_Meistr_GodDialog(_God,2,_Dialog)
AND
QRY_StartDialog(0,_Dialog,_God,_Player)
THEN
DB_RC_DW_Meistr_Puzzle2Started(_Player);

PROC
ProcObjectTimerFinished(_Player,"RC_DW_Meistr_Dream_Puzzle2")
AND
NOT DB_RC_DW_Meistr_Puzzle2Started((CHARACTERGUID)_Player)
THEN
ProcObjectTimer(_Player,"RC_DW_Meistr_Dream_Puzzle2",2000);

PROC
ProcObjectTimerFinished(_Player,"RC_DW_Meistr_Dream_Puzzle2")
THEN
NOT DB_RC_DW_Meistr_Puzzle2Started((CHARACTERGUID)_Player);

IF
ObjectFlagSet("RC_DW_Meistr_GiveSpiritVision",_Player,_)
THEN
CharacterAddSkill((CHARACTERGUID)_Player,"Shout_SpiritVision");
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_VisionGotten");
PlayEffect(_Player,"RS3_FX_GP_ScriptedEvent_HOE_AcquireSpiritVision_01");

IF
ObjectFlagSet("RC_DW_Meistr_GiveSourceVampirism",_Player,_)
AND
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,(CHARACTERGUID)_Player,_,_,_)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_Portal,_God)
THEN
CharacterAddSkill((CHARACTERGUID)_Player,"Target_SourceVampirism");
ObjectClearFlag(_God,"RC_DW_Meistr_ShowPortal",0);
ObjectClearFlag(_Player,"RC_DW_Meistr_OpenedPortal",0);
PlayEffect(_Player,"RS3_FX_GP_ScriptedEvent_HOE_AcquireSourceVampirism_01");

IF
ObjectFlagSet("RC_DW_Meistr_KnowCoS",_Player,_)
AND
DB_RC_DB_Meistr_Dream_Occupied(_,(CHARACTERGUID)_Player,_,_,_)
THEN
PROC_LoopEffect("RS3_FX_GP_ScriptedEvent_RC_Vision_Dream_Puzzle_01",_Player,"MeistrPuzzle3FX","RC_Main","Dummy_StatusFX");

IF
DialogEnded(_Puzzle3Dialog,_ID)
AND
DB_RC_DW_Meistr_GodDialog(_,3,_Puzzle3Dialog)
AND
DB_DialogPlayers(_ID,_Player,1)
THEN
PROC_StopLoopEffect(_Player,"MeistrPuzzle3FX");

IF
ObjectFlagSet("RC_DW_Meistr_GiveSourceVampirism",_Player,_)
AND
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,(CHARACTERGUID)_Player,_,_,_)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_Portal,_God)
AND
DB_RC_DW_Meistr_PortalIsShowing(_Portal)
THEN
Poof(_Portal);
NOT DB_RC_DW_Meistr_PortalIsShowing(_Portal);

IF
ObjectFlagSet("RC_DW_Meistr_GiveCurse",_Player,_)
THEN
CharacterAddSkill((CHARACTERGUID)_Player,"Target_Curse");

IF
ObjectFlagSet("RC_DW_Meistr_ShowPortal",(CHARACTERGUID)_God,_)
AND
DB_RC_DB_Meistr_Dream(_,_Portal,_God)
THEN
DB_RC_DW_Meistr_Dream_ShowPortalAfterDialog(_God,_Portal);

IF
DialogEnded(_Dialog,_)
AND
DB_RC_DW_Meistr_GodDialog(_God,_,_Dialog)
AND
DB_RC_DW_Meistr_Dream_ShowPortalAfterDialog(_God,_Portal)
THEN
Foop(_Portal);
DB_RC_DW_Meistr_PortalIsShowing(_Portal);
NOT DB_RC_DW_Meistr_Dream_ShowPortalAfterDialog(_God,_Portal);

IF
CharacterUsedItem(_Player,_DreamSequenceEnder)
AND
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,_Player,_X,_Y,_Z)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_,_God)
AND
DB_Dialogs(_God,_CurrentDiag)
AND
DB_RC_DW_Meistr_GodDialog(_God,2,_CurrentDiag)
THEN
ObjectSetFlag(_Player,"RC_DW_Meistr_Dream_Visit1");

IF
CharacterUsedItem(_Player,_DreamSequenceEnder)
AND
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,_Player,_X,_Y,_Z)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_,_God)
AND
DB_Dialogs(_God,_CurrentDiag)
AND
DB_RC_DW_Meistr_GodDialog(_God,3,_CurrentDiag)
THEN
ObjectSetFlag(_Player,"RC_DW_Meistr_Dream_Visit2");

IF
CharacterUsedItem(_Player,_DreamSequenceEnder)
AND
DB_RC_DB_Meistr_Dream(_,_DreamSequenceEnder,_)
AND
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,_Player,_X,_Y,_Z)
THEN
TeleportToPosition(_Player,_X,_Y,_Z,"",0);
NOT DB_RC_DB_Meistr_Dream_Occupied(_Trigger,_Player,_X,_Y,_Z);
PROC_RC_DW_Meistr_Completed_DreamSequence(_Player);

IF
CharacterUsedSkillOnTarget(_Player,(CHARACTERGUID)_God,"Target_SourceVampirism",_,_)
AND
DB_RC_DB_Meistr_Dream(_,_,_God)
AND
DB_RC_DW_Meistr_GodDialog(_God,3,_Dialog)
THEN
ProcRemoveAllDialogEntriesForSpeaker(_God);
DB_Dialogs(_God,_Dialog);
ProcObjectTimer(_Player,"RC_DW_Meistr_Dream_Puzzle3",3000);

IF
SavegameLoaded(_Major,_Minor,_Rev,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Rev,_Build, 3, 6, 1, 0)
AND
DB_RC_DW_Meistr_GodDialog(_God,3,_Puzzle3Dialog)
AND
DB_Dialogs(_God,_Puzzle3Dialog)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_Portal,_God)
AND
DB_RC_DW_Meistr_Dream_AssignedChamber(_Player,_Trigger)
AND
ObjectGetFlag(_Player,"GLO_HasSourceVampirism",0)
AND
DB_RC_DW_Meistr_GodDialog(_God,2,_Puzzle2Dialog)
THEN
ProcRemoveAllDialogEntriesForSpeaker(_God);
DB_Dialogs(_God,_Puzzle2Dialog);
ObjectClearFlag(_Player,"RC_DW_Meistr_Dream_Visit2",0);
Poof(_Portal);
NOT DB_RC_DW_Meistr_PortalIsShowing(_Portal);
ObjectClearFlag(_God,"RC_DW_Meistr_ShowPortal",0);
ObjectClearFlag(_Player,"RC_DW_Meistr_OpenedPortal",0);
DB_BUGFIX_Marker(_Player,"DOS2EE-7011");

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"RC_DW_Meistr_Dream_Puzzle3")
AND
DB_RC_DB_Meistr_Dream_Occupied(_Trigger,_Player,_,_,_)
AND
DB_RC_DB_Meistr_Dream(_Trigger,_,_God)
AND
DB_RC_DW_Meistr_GodDialog(_God,3,_Dialog)
THEN
Proc_StartDialog(0,_Dialog,_God,_Player);
//END_REGION

//REGION After DreamSequence
IF
ObjectFlagSet("GLO_HasSourceVampirism",_Player,_)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Vampirism");

IF
ObjectFlagSet("RC_DW_Meistr_KnowCoS",_Player,_)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Location");

PROC
PROC_RC_DW_Meistr_Completed_DreamSequence((CHARACTERGUID)_Player)
AND
DB_RC_DW_Meistr_NonControlledInDream(_Companion)
AND
ObjectGetFlag(_Player,"GLO_HasSourceVampirism",1)
THEN
CharacterAddSkill(_Companion,"Target_SourceVampirism");
ObjectSetFlag(_Companion,"RC_DW_Meistr_Dream_Visit2");

PROC
PROC_RC_DW_Meistr_Completed_DreamSequence((CHARACTERGUID)_Player)
AND
DB_RC_DW_Meistr_NonControlledInDream(_Companion)
THEN
//RemoveStatus(_Companion,"SLEEPING");
// What to make this?
RemoveStatus(_Companion,"SleepingH");
CharacterAddSkill(_Companion,"Shout_SpiritVision");
NOT DB_RC_DW_Meistr_NonControlledInDream(_Companion);
ObjectSetFlag(_Companion,"RC_DW_Meistr_Dream_Visit1");

PROC
PROC_RC_DW_Meistr_Completed_DreamSequence((CHARACTERGUID)_Player)
AND
DB_CompanionAvatarBond(_Origin,_Player)
THEN
Proc_UnlockSourcePointsAndPowers(_Origin,_Player);

PROC
PROC_RC_DW_Meistr_Completed_DreamSequence((CHARACTERGUID)_Player)
AND
NOT DB_InRegion(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c)
THEN
ProcObjectTimer(_Player,"RC_DW_RD_Meistr_AfterArtefact",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"RC_DW_RD_Meistr_AfterArtefact")
AND
ObjectGetFlag(_Player,"RC_DW_Meistr_KnowCoS",0)
THEN
ProcDefineReflectionDialog("RC_DW_RD_Meistr_AfterArtefact",_Player);

PROC
PROC_RC_DW_Meistr_Completed_DreamSequence((CHARACTERGUID)_Player)
THEN
ProcObjectTimer(_Player,"RC_DW_RD_Meistr_KnowCoS",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"RC_DW_RD_Meistr_KnowCoS")
AND
ObjectGetFlag(_Player,"RC_DW_Meistr_KnowCoS",1)
THEN
ProcDefineReflectionDialog("RC_DW_RD_Meistr_KnowCoS",_Player);

PROC
PROC_RC_DW_Meistr_Completed_DreamSequence((CHARACTERGUID)_Player)
AND
DB_InRegion(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c)
THEN
ProcObjectTimer(_Player,"RC_DW_Meistr_PlayerReturnedFromDreamscene",500);

PROC
PROC_RC_DW_Meistr_Completed_DreamSequence((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player,"RC_DW_Meistr_KnowCoS",1)
AND
NOT DB_InRegion(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c)
THEN
Proc_RC_DW_Meistr_Death_Start();

PROC
ProcObjectTimerFinished(_Player,"RC_DW_Meistr_PlayerReturnedFromDreamscene")
THEN
DB_RC_DW_Meistr_KillAfterDialog(1);

PROC
ProcObjectTimerFinished(_Player,"RC_DW_Meistr_PlayerReturnedFromDreamscene")
AND
ObjectIsInTrigger(_Player,TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c,1)
THEN
UserSetFlag((CHARACTERGUID)_Player,"RC_DW_Meistr_FromDreamsceneInsideCellar");
PROC_StartDialog(0,"RC_DW_Meistr_Artefact_Guide",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,_Player);

PROC
PROC_RC_DW_Meistr_Completed_DreamSequence((CHARACTERGUID)_Player)
AND
DB_RC_DW_Meistr_PlayerUsedSmoke(_Player,_SmokePortal)
AND
DB_RC_DW_Meistr_BowlBurning(_Portal)
THEN
DialogRequestStop(_Portal);
ProcRemoveAllDialogEntriesForSpeaker(_Portal);
ItemRemove(_Portal);
NOT DB_RC_DW_Meistr_BowlBurning(_Portal);
NOT DB_RC_DW_Meistr_PlayerUsedSmoke(_Player,_SmokePortal);

IF
DialogEnded("RC_DW_Meistr_Artefact_Guide",_DlgInst)
AND
DB_DialogPlayers(_DlgInst,_Player,1)
AND
ObjectGetFlag(_Player,"RC_DW_Meistr_KnowCoS",1)
AND
DB_RC_DW_Meistr_KillAfterDialog(1)
THEN
NOT DB_RC_DW_Meistr_KillAfterDialog(1);
Proc_RC_DW_Meistr_Death_Start();
//END_REGION

//REGION Journal Entries
IF
DialogEnded("RC_DU_VL_River",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,1)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_RC_DW_Meistr_Start");
ObjectSetFlag(_Player,"QuestUpdate_FTJ_Godwoken_SeekMeistr");


// Gallows
IF
CharacterSawCharacter(_Player,CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d)
AND
DB_IsPlayer(_Player)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Rescued")
AND
NOT DB_Dead(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_FoundGallows");


IF
ObjectFlagSet("RC_DW_KnowReimondHungMeistr",_Player,_)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Rescued",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Gallows");

IF
DialogEnded("RC_DW_Meistr_Gallows",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,1)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Rescued",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Gallows");

IF
ObjectFlagSet("RC_DW_Meistr_RescueParty",(CHARACTERGUID)_Player,_)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Rescued");


//Cellar
IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c)
AND
GlobalGetFlag("RC_DW_Meistr_Dead",0)
AND
GlobalGetFlag("RC_DW_Meistr_House_GuideCellar",1)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_CellarAlone",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Cellar");

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c)
AND
GlobalGetFlag("RC_DW_Meistr_Dead",1)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Cellar",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_CellarAlone");

IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_DW_Meistr_Cellar_d745d7de-efa4-4034-9774-7d1ddd1f913c)
AND
GlobalGetFlag("RC_DW_Meistr_House_GuideCellar",0)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Cellar",0)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_CellarAlone");


IF
CharacterEnteredTrigger(_Player,TRIGGERGUID_S_RC_DW_Meistr_House_GroundFloor_9e49918d-6ac4-4ef1-81ae-d113dceda62a)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Rescued")
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_HomeAlone");


//Hatch
IF
ObjectFlagSet("RC_DW_Meistr_SivaHatch_SetUpdate",(CHARACTERGUID)_Player,_)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Rescued")
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Dead")
AND
NOT DB_GlobalFlag("RC_DW_Meistr_VaultUnlocked")
AND
PartyGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_HouseInstruction",0)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_SivaHatch");

IF
ObjectFlagSet("RC_DW_Meistr_SivaHatch_SetUpdate",(CHARACTERGUID)_Player,_)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Rescued")
AND
DB_GlobalFlag("RC_DW_Meistr_Dead")
AND
NOT DB_GlobalFlag("RC_DW_Meistr_VaultUnlocked")
AND
PartyGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_HouseInstruction",0)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_SivaHatch_Dead");

// Source vamp
IF
ObjectFlagSet("RC_DW_Meistr_ReceiveHeist_Meistr",(CHARACTERGUID)_Player,_)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Heist_Meistr");
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_MagisterRecords_LearnSourceVamp");

IF
ObjectFlagSet("RC_DW_Meistr_ReceiveHeist_Ghost",(CHARACTERGUID)_Player,_)
THEN
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Heist_Ghost");
ObjectSetFlag(_Player,"QuestUpdate_RC_DW_MagisterRecords_LearnSourceVamp");

IF
ObjectFlagSet("QuestUpdate_RC_DW_Meistr_Heist_Ghost", (CHARACTERGUID)_Player, _)
THEN
PartySetFlag(_Player, "RC_DW_Meistr_ReceiveHeist");

IF
ObjectFlagSet("QuestUpdate_RC_DW_Meistr_Heist_Meistr", (CHARACTERGUID)_Player, _)
THEN
PartySetFlag(_Player, "RC_DW_Meistr_ReceiveHeist");


// skills & MP
IF
ObjectFlagSet("QuestUpdate_RC_DW_Meistr_VisionGotten",_Player,_)
AND
ObjectGetFlag(_Player,"GLO_Has2MaxMP",0)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_RC_DW_Meistr_Need2SP");

IF
ObjectFlagSet("QuestUpdate_RC_DW_Meistr_Vampirism",_Player,_)
AND
ObjectGetFlag(_Player,"GLO_Has3MaxMP",0)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_RC_DW_Meistr_Need3SP");


// warowl
IF
DialogStarted("RC_LV_MaladyWarOwlMessageToPlayer",_Inst)
AND
DB_DialogPlayers(_Inst,_Player,_)
THEN
PartySetFlag((CHARACTERGUID)_Player,"QuestUpdate_RC_DW_Meistr_Location_Owl");


// Dead Meistr
IF
CharacterSawCharacter(_Player,CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d)
AND
DB_IsPlayer(_Player)
AND
DB_Dead(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d)
THEN
Proc_RC_DW_Meistr_Meistr_Death_SetUpdate(_Player);

IF
CharacterDied(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d)
AND
DB_IsPlayer(_Player)
AND
CharacterCanSee(_Player,CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,1)
THEN
Proc_RC_DW_Meistr_Meistr_Death_SetUpdate(_Player);

PROC
Proc_RC_DW_Meistr_Meistr_Death_SetUpdate((CHARACTERGUID)_Player)
AND
DB_GlobalFlag("RC_DW_Meistr_KilledByVoidwoken")
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Meistr_Death_Scene");

PROC
Proc_RC_DW_Meistr_Meistr_Death_SetUpdate((CHARACTERGUID)_Player)
AND
NOT DB_GlobalFlag("RC_DW_Meistr_KilledByVoidwoken")
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_Meistr_Death_Gen");
PartySetFlag(_Player,"QuestUpdate_FTJ_Seeker_MeistrDied");

//END_REGION

//REGION Source Knowledge Unlocks
//reset the event
IF
ObjectFlagSet(_Event,_Player,_)
AND
DB_RC_DW_Meistr_SourceKnowledge(_,_Event)
AND
StringConcatenate(_Event,"_Learned",_LearnedFlag)
THEN
ObjectClearFlag(_Player,_Event,0);
ObjectSetFlag(_Player,_LearnedFlag);

//If not learnt, increase the counter.
IF
ObjectFlagSet(_Event,(CHARACTERGUID)_Player,_ID)
AND
DB_RC_DW_Meistr_SourceKnowledge(_,_Event)
AND
NOT DB_RC_DW_Meistr_SourceKnowledge_Unlocked(_Player,_Event)
THEN
DB_RC_DW_Meistr_SourceKnowledge_Unlocked(_Player,_Event);
Proc_ObjectCountHelper(_Player,"RC_DW_Meistr_SourceKnowledgeCounter");
PROC_RC_DW_Meistr_SPLearningVB(_Player,_ID);

// When set outside a dialog
PROC
PROC_RC_DW_Meistr_SPLearningVB((CHARACTERGUID)_Player,0)
THEN
PROC_RC_DW_Meistr_SourceKnowledgeLearned2SPVoiceBark((CHARACTERGUID)_Player);
PROC_RC_DW_Meistr_SourceKnowledgeLearned3SPVoiceBark((CHARACTERGUID)_Player);

PROC
PROC_RC_DW_Meistr_SPLearningVB((CHARACTERGUID)_Player,(INTEGER)_Inst)
AND
_Inst != 0
THEN
DB_RC_DW_Meistr_SourceKnowLedge_VBAfterDialog(_Player,_Inst);

IF
DB_ObjectCountHelper(_Player,"RC_DW_Meistr_SourceKnowledgeCounter",1)
THEN
ObjectSetFlag(_Player,"GLO_Has2MaxMP");
ProcCharacterOverrideMaxSourcePointsWithEffect((CHARACTERGUID)_Player,2);

IF
DB_ObjectCountHelper(_Player,"RC_DW_Meistr_SourceKnowledgeCounter",2)
THEN
ObjectSetFlag(_Player,"GLO_Has3MaxMP");
ProcCharacterOverrideMaxSourcePointsWithEffect((CHARACTERGUID)_Player,3);

PROC
ProcCharacterOverrideMaxSourcePointsWithEffect((CHARACTERGUID)_Character,2)
THEN
CharacterOverrideMaxSourcePoints(_Character,2);
PlayEffect(_Character,"RS3_FX_GP_ScriptedEvent_Unlock_SourcePoint_02");

PROC
ProcCharacterOverrideMaxSourcePointsWithEffect((CHARACTERGUID)_Character,3)
THEN
CharacterOverrideMaxSourcePoints(_Character,3);
PlayEffect(_Character,"RS3_FX_GP_ScriptedEvent_Unlock_SourcePoint_03");

IF
DialogEnded(_Dialog,_Inst)
AND
DB_RC_DW_Meistr_SourceKnowLedge_VBAfterDialog(_Player,_Inst)
THEN
NOT DB_RC_DW_Meistr_SourceKnowLedge_VBAfterDialog(_Player,_Inst);
PROC_RC_DW_Meistr_SourceKnowledgeLearned2SPVoiceBark((CHARACTERGUID)_Player);
PROC_RC_DW_Meistr_SourceKnowledgeLearned3SPVoiceBark((CHARACTERGUID)_Player);

PROC
PROC_RC_DW_Meistr_SourceKnowledgeLearned2SPVoiceBark((CHARACTERGUID)_Player)
AND
DB_ObjectCountHelper((CHARACTERGUID)_Player,"RC_DW_Meistr_SourceKnowledgeCounter",1)
AND
ObjectGetFlag(_Player,"GLO_HasSpiritVision",1)
AND
QueryOnlyOnce("RC_DW_VB_Meistr_After2SP")
THEN
StartVoiceBark("RC_DW_VB_Meistr_After2SP",_Player);
DB_RC_DW_VB_Meistr_After_VoiceBark("RC_DW_VB_Meistr_After2SP","RC_DW_Meistr_After2SP",_Player);

PROC
PROC_RC_DW_Meistr_SourceKnowledgeLearned3SPVoiceBark((CHARACTERGUID)_Player)
AND
DB_ObjectCountHelper((CHARACTERGUID)_Player,"RC_DW_Meistr_SourceKnowledgeCounter",2)
AND
ObjectGetFlag(_Player,"GLO_HasSpiritVision",1)
AND
QueryOnlyOnce("RC_DW_VB_Meistr_After3SP")
THEN
StartVoiceBark("RC_DW_VB_Meistr_After3SP",_Player);
DB_RC_DW_VB_Meistr_After_VoiceBark("RC_DW_VB_Meistr_After3SP","RC_DW_Meistr_After3SP",_Player);

PROC
PROC_RC_DW_Meistr_SourceKnowledgeLearned2SPVoiceBark((CHARACTERGUID)_Player)
AND
DB_ObjectCountHelper((CHARACTERGUID)_Player,"RC_DW_Meistr_SourceKnowledgeCounter",1)
AND
ObjectGetFlag(_Player,"GLO_HasSpiritVision",1)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_HallOfEchoes",1)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_2SP");

PROC
PROC_RC_DW_Meistr_SourceKnowledgeLearned2SPVoiceBark((CHARACTERGUID)_Player)
AND
DB_ObjectCountHelper((CHARACTERGUID)_Player,"RC_DW_Meistr_SourceKnowledgeCounter",1)
AND
ObjectGetFlag(_Player,"GLO_HasSpiritVision",1)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_HallOfEchoes",0)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_2SP_NoMeistr");

PROC
PROC_RC_DW_Meistr_SourceKnowledgeLearned3SPVoiceBark((CHARACTERGUID)_Player)
AND
DB_ObjectCountHelper((CHARACTERGUID)_Player,"RC_DW_Meistr_SourceKnowledgeCounter",2)
AND
ObjectGetFlag(_Player,"GLO_HasSpiritVision",1)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_HallOfEchoes",1)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_3SP");

PROC
PROC_RC_DW_Meistr_SourceKnowledgeLearned3SPVoiceBark((CHARACTERGUID)_Player)
AND
DB_ObjectCountHelper((CHARACTERGUID)_Player,"RC_DW_Meistr_SourceKnowledgeCounter",2)
AND
ObjectGetFlag(_Player,"GLO_HasSpiritVision",1)
AND
PartyGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_HallOfEchoes",0)
THEN
PartySetFlag(_Player,"QuestUpdate_RC_DW_Meistr_3SP_NoMeistr");

IF
VoiceBarkEnded(_VoiceBark,_ID)
AND
DB_RC_DW_VB_Meistr_After_VoiceBark(_VoiceBark,_Dialog,_Player)
AND
DB_DialogPlayers(_ID,_Player,1)
AND
ObjectGetFlag(_Player, "QuestUpdate_RC_DW_Meistr_VisionGotten", 1)
THEN 
ProcStartMeistrMandatoryDialog(_Dialog,_Player);

PROC
ProcStartMeistrMandatoryDialog((STRING)_Dialog,(CHARACTERGUID)_Player)
THEN
DB_RC_DW_MeistrVBDialog(_Dialog,_Player);
ProcObjectTimer(_Player,"RCDW_StartMeistrVB",0);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"RCDW_StartMeistrVB")
AND
DB_ReflectionDialog_Players(_,_Player,_)
THEN
ProcObjectTimer(_Player,"RCDW_StartMeistrVB",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Player,"RCDW_StartMeistrVB")
AND
DB_RC_DW_MeistrVBDialog(_Dialog,_Player)
AND 
NOT DB_ReflectionDialog_Players(_,_Player,_)
THEN
NOT DB_RC_DW_MeistrVBDialog(_Dialog,_Player);
PROC_MandatoryOneSpeakerDialog(_Dialog,(CHARACTERGUID)_Player);

IF
VoiceBarkFailed(_VoiceBark)
AND
DB_RC_DW_VB_Meistr_After_VoiceBark(_VoiceBark,_Dialog,_Player)
THEN
ProcStartMeistrMandatoryDialog(_Dialog,_Player);

//END_REGION

//REGION Meistrs death in VW attack
IF
DB_RC_DW_Meistr_VW_Attackers(_VW)
THEN
SetFaction(_VW,"Neutral NPC");
SetOnStage(_VW,0);

IF
TextEventSet("meistrdiegallows")
THEN
TeleportTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,TRIGGERGUID_S_RC_DW_Meistr_OffGallows_3e36450d-24c9-45a8-bb89-9f52a9bc0883);
Proc_RC_DW_Meistr_Death_Start();

IF
TextEventSet("meistrdiehouse")
THEN
ClearVarObject(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Seat");
ItemSetOnlyOwnerCanUse(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d,0);
ItemClearOwner(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
ItemUnLock(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
SetOnStage(ITEMGUID_S_RC_DW_Meistr_House_Notice_9ab791f4-14d0-453d-9522-f026fe26181c,0);
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
GlobalSetFlag("RC_DW_Meistr_Rescued");
GlobalSetFlag("RC_DW_Meistr_AtHome");
TeleportTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,TRIGGERGUID_S_RC_DW_MeistrHouse_c6bbf267-2bb9-47ea-a92a-3fe6be512e59);
CharacterUseItem(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,ITEMGUID_S_RC_DW_Meistr_House_Chair_ab253d51-6d69-4f47-91cd-ff1c43f9a406,"dbg_MeistrSatOnChair");

IF
TextEventSet("meistrdie")
THEN
ClearVarObject(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Seat");
ItemSetOnlyOwnerCanUse(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d,0);
ItemClearOwner(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
ItemUnLock(ITEMGUID_S_RC_DW_Meistr_HouseDoor_fe9ad05b-ffc8-4b6a-ac80-e10148b38d2d);
SetOnStage(ITEMGUID_S_RC_DW_Meistr_House_Notice_9ab791f4-14d0-453d-9522-f026fe26181c,0);
ProcRemoveAllDialogEntriesForSpeaker(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
GlobalSetFlag("RC_DW_Meistr_Rescued");
GlobalSetFlag("RC_DW_Meistr_AtHome");
GlobalSetFlag("RC_DW_Meistr_AtCellar");
TeleportTo(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,TRIGGERGUID_S_RC_DW_Meistr_VB_Cellar_1ca2fffe-de4b-4728-8065-4c2f1f54b3bc,"",1);
CharacterUseItem(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,ITEMGUID_S_RC_DW_Meistr_Cellar_Chair_b5ef08d8-fe40-48a6-bf78-b74f7466ac3a,"dbg_MeistrSatOnChair");

IF
StoryEvent(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"dbg_MeistrSatOnChair")
THEN
Proc_RC_DW_Meistr_Death_Start();

IF
TextEventSet("meistrclear")
AND
DB_RC_DW_Meistr_VW_Attackers(_VW)
THEN
GlobalClearFlag("RC_DW_Meistr_Rescued");
GlobalClearFlag("RC_DW_Meistr_AtHome");
GlobalClearFlag("RC_DW_Meistr_AtCellar");
Poof(_VW);
CharacterResurrect(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);


PROC
Proc_RC_DW_Meistr_Death_TeleportVW()
AND
NOT DB_GlobalFlag("RC_DW_Meistr_Rescued")
AND
DB_RC_DW_Meistr_VW_Attackers(_VW)
AND
DB_RC_DW_Meistr_VW_Points(_VW,1,_Tp)
THEN
TeleportTo(_VW,_Tp);

PROC
Proc_RC_DW_Meistr_Death_TeleportVW()
AND
DB_GlobalFlag("RC_DW_Meistr_Rescued")
AND
NOT DB_GlobalFlag("RC_DW_Meistr_AtHome")
AND
DB_RC_DW_Meistr_VW_Attackers(_VW)
THEN
TeleportTo(_VW,CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);

PROC
Proc_RC_DW_Meistr_Death_TeleportVW()
AND
DB_GlobalFlag("RC_DW_Meistr_AtHome")
AND
NOT DB_GlobalFlag("RC_DW_Meistr_AtCellar")
AND
DB_RC_DW_Meistr_VW_Attackers(_VW)
AND
DB_RC_DW_Meistr_VW_Points(_VW,2,_Tp)
THEN
TeleportTo(_VW,_Tp);

PROC
Proc_RC_DW_Meistr_Death_TeleportVW()
AND
DB_GlobalFlag("RC_DW_Meistr_AtCellar")
AND
DB_RC_DW_Meistr_VW_Attackers(_VW)
AND
DB_RC_DW_Meistr_VW_Points(_VW,3,_Tp)
THEN
TeleportTo(_VW,_Tp);

PROC
Proc_RC_DW_Meistr_Death_TeleportVW()
AND
DB_RC_DW_Meistr_VW_Attackers(_VW)
THEN
PlayEffect(_VW,"RS3_FX_GP_ScriptedEvent_HannagPortal_01_Void_Summon");

PROC
Proc_RC_DW_Meistr_Death_Start()
AND
NOT DB_Dead(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d)
THEN
Proc_RC_DW_Meistr_Death_Spawn();

PROC
Proc_RC_DW_Meistr_Death_Spawn()
AND
DB_RC_DW_Meistr_VW_Attackers(_VW)
THEN
SetCanJoinCombat(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0);
Proc_RC_DW_Meistr_Death_TeleportVW();
CharacterAppear(_VW,1,"RC_DW_Meistr_Death_VWAppear");
ProcSetInvulnerable(_VW,1);
ProcForceStopDialog(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
ProcClearStoryMove(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
Proc_StartDialog(1,"RC_DW_AD_Meistr_BeforeDeath",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d);
ProcObjectTimer(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_MortalBlow",200);
Proc_RC_DW_Meistr_Death_TryCast();

PROC
Proc_RC_DW_Meistr_Death_TryCast()
AND
DB_GlobalFlag("RC_DW_Meistr_Rescued")
THEN
RemoveStatus(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"SITTING");
CharacterLookAt(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_01_b31d9186-34e6-423d-9a33-f90b27f567c2);
CharacterUseSkill(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Projectile_EnemyFireball",CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_01_b31d9186-34e6-423d-9a33-f90b27f567c2,1,1,1);

PROC
ProcObjectTimerFinished(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"RC_DW_Meistr_MortalBlow")
THEN
Proc_RC_DW_Meistr_Death_Killed();

PROC
Proc_RC_DW_Meistr_Death_Killed()
THEN
CharacterUseSkill(CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_01_b31d9186-34e6-423d-9a33-f90b27f567c2,"Projectile_Quest_ExecuteMeistr",CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,1,1,1);

IF
CharacterUsedSkillOnTarget(CHARACTERGUID_S_RC_DW_Meistr_Voidwoken_Killer_01_b31d9186-34e6-423d-9a33-f90b27f567c2,CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,"Projectile_Quest_ExecuteMeistr",_,_)
THEN
GlobalSetFlag("RC_DW_Meistr_KilledByVoidwoken");
TimerLaunch("RC_DW_MeistrDiesByVoidwoken",1000);

IF
TimerFinished("RC_DW_MeistrDiesByVoidwoken")
THEN
CharacterSetImmortal(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,0);
CharacterDie(CHARACTERGUID_S_GLO_Meistr_01ae5541-cef7-4d3a-8799-cee7f3d3c34d,1,"Physical");

PROC
Proc_RC_DW_Meistr_Death_Killed()
AND
DB_RC_DW_Meistr_VW_Attackers(_VW)
THEN
ProcSetInvulnerable(_VW,0);
SetFaction(_VW,"Evil NPC");
//END_REGION

//REGION Malady and leaving for CoS
IF
GlobalFlagSet("RC_DW_River_CoSFallbackTriggered")
AND
DB_IsPlayer(_Char)
AND
UserGetFlag(_Char,"QuestUpdate_RC_DW_Meistr_Location_Fail",0)
THEN
UserSetFlag(_Char,"QuestUpdate_RC_DW_Meistr_Location_Fail",0);

IF
ObjectFlagSet("QuestUpdate_RC_DW_Meistr_Location",_Char,_)
AND
ObjectGetFlag(CHARACTERGUID_S_GLO_River_f4931ebe-10b0-43c4-9182-640cf052717e,"RC_LV_Coordinator",_MaladyOnLV)
AND
DB_RC_DW_Meistr_MaladyForCoSUpdate(_MaladyOnLV,_Update)
THEN
ObjectSetFlag(_Char,_Update);

//CLOSE SUBS IF ALL THE SP ARE FOUND - The other quests can still be completed!
IF
ObjectFlagSet("QuestUpdate_RC_DW_Meistr_SummonMalady",(CHARACTERGUID)_Player,_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"QuestUpdate_RC_DW_Meistr_3SP",1)
THEN
ObjectSetFlag(_Player,"RC_DW_Meistr_CloseQuest_SummonMalady");


// Via the Meistr
IF
ObjectFlagSet("RC_DW_Meistr_KnowCoS",_Player,_)
THEN
UserSetFlag((CHARACTERGUID)_Player,"RC_DW_KnowCos");

// Via the demon on Blood Island
IF
ObjectFlagSet("RC_BI_ThePresence_KnowCoS",_Player,_)
THEN
UserSetFlag((CHARACTERGUID)_Player,"RC_DW_KnowCos");

//Some mods seem to break the previous two rules. So we enforce it again on every gameload.
IF
SavegameLoaded(_,_,_,_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"RC_DW_Meistr_KnowCoS",1)
AND
UserGetFlag(_Player,"RC_DW_KnowCos",0)
THEN
UserSetFlag((CHARACTERGUID)_Player,"RC_DW_KnowCos");
DB_BUGFIX_Marker(_Player,"DOS2EE-7238");

IF
SavegameLoaded(_,_,_,_)
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player,"RC_BI_ThePresence_KnowCoS",1)
AND
UserGetFlag(_Player,"RC_DW_KnowCos",0)
THEN
UserSetFlag((CHARACTERGUID)_Player,"RC_DW_KnowCos");
DB_BUGFIX_Marker(_Player,"DOS2EE-7238");
//END_REGION

//REGION Source point counter (DOS2EE-7346)
QRY
QRY_RC_DW_Meistr_WrongSPFixApplied(3,6,1,1)
THEN
DB_NOOP(1);

IF
SavegameLoaded(_Major,_Minor,_Revision,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Revision,_Build,3,6,1,2)
AND
// (wrong) fix already applied or new playthrough -> don't reset the maximum source points
// because there's a problem if the player already went through the god scene with that wrong
// number of source points
NOT QRY_RC_DW_Meistr_WrongSPFixApplied(_Major,_Minor,_Revision,_Build)
AND
DB_JoinedParty(_Char)
THEN
PROC_RC_DW_Meistr_SetSourcePointCounter(_Char);

PROC
PROC_RC_DW_Meistr_SetSourcePointCounter((CHARACTERGUID)_Char)
AND
DB_ObjectCountHelper(_Char,"RC_DW_Meistr_SourceKnowledgeCounter",_Count)
THEN
NOT DB_ObjectCountHelper(_Char,"RC_DW_Meistr_SourceKnowledgeCounter",_Count);

PROC
PROC_RC_DW_Meistr_SetSourcePointCounter((CHARACTERGUID)_Char)
AND
ObjectGetFlag(_Char, "GLO_Has2MaxMP", 1)
AND
ObjectGetFlag(_Char, "GLO_Has3MaxMP", 0)
THEN
DB_ObjectCountHelper(_Char,"RC_DW_Meistr_SourceKnowledgeCounter",1);
DB_BUGFIX_Marker(_Char,"DOS2EE-7346b");

PROC
PROC_RC_DW_Meistr_SetSourcePointCounter((CHARACTERGUID)_Char)
AND
ObjectGetFlag(_Char, "GLO_Has3MaxMP", 1)
THEN
DB_ObjectCountHelper(_Char,"RC_DW_Meistr_SourceKnowledgeCounter",2);
DB_BUGFIX_Marker(_Char,"DOS2EE-7346c");

// wrong fix applied for people with 3sp -> trigger 3sp voicebark
// that they may have missed (it has a QueryOnlyOnce, so if they did
// get it, it won't trigger again)
IF
SavegameLoaded(_Major,_Minor,_Revision,_Build)
AND
QRY_RC_DW_Meistr_WrongSPFixApplied(_Major,_Minor,_Revision,_Build)
AND
DB_JoinedParty(_Char)
AND
ObjectGetFlag(_Char, "GLO_Has3MaxMP", 1)
THEN
PROC_RC_DW_Meistr_SourceKnowledgeLearned3SPVoiceBark(_Char);
DB_BUGFIX_Marker(_Char,"DOS2EE-7346a");
//END_REGION
EXITSECTION
SysClear("DB_RC_DW_Meistr_VW_Attackers",1);
SysClear("DB_RC_DW_Meistr_VW_Points",2);
ENDEXITSECTION
ParentTargetEdge "ReapersCoast"
